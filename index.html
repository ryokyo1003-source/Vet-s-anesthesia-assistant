<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>VetAnes - Áç£ÂåªÈ∫ªÈÖîÁÆ°ÁêÜ</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
<style>
  :root {
    --bg-primary: #0a0e1a;
    --bg-secondary: #111827;
    --bg-card: #1a2236;
    --bg-card-hover: #1e2a42;
    --border: #2a3550;
    --text-primary: #e8ecf4;
    --text-secondary: #8892a8;
    --text-muted: #5a6478;
    --accent-blue: #3b82f6;
    --accent-green: #10b981;
    --accent-red: #ef4444;
    --accent-yellow: #f59e0b;
    --accent-purple: #8b5cf6;
    --accent-cyan: #06b6d4;
    --accent-orange: #f97316;
    --accent-pink: #ec4899;
    --hr-color: #ef4444;
    --spo2-color: #3b82f6;
    --rr-color: #f59e0b;
    --bp-color: #10b981;
    --etco2-color: #8b5cf6;
    --temp-color: #06b6d4;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif;
    background: var(--bg-primary); color: var(--text-primary);
    overflow: hidden; height: 100vh; width: 100vw;
    -webkit-touch-callout: none; -webkit-user-select: none; user-select: none;
  }

  /* ===== STARTUP SCREEN ===== */
  #startupScreen {
    position: fixed; inset: 0; z-index: 1000;
    background: var(--bg-primary);
    display: flex; align-items: center; justify-content: center;
  }
  .startup-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 20px; padding: 32px 36px;
    width: 720px; max-height: 92vh;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
  }
  .startup-title-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 4px;
  }
  .btn-settings-gear {
    width: 48px; height: 48px; border-radius: 12px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    color: var(--accent-yellow); font-size: 22px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; -webkit-tap-highlight-color: rgba(245,158,11,0.3);
    transition: background 0.15s;
  }
  .btn-settings-gear:active { background: var(--bg-card-hover); }
  .startup-card h1 {
    font-size: 30px; font-weight: 700; margin-bottom: 4px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .startup-card p.sub { color: var(--text-secondary); margin-bottom: 20px; font-size: 14px; }
  .form-section-title {
    font-size: 13px; font-weight: 700; color: var(--accent-cyan);
    letter-spacing: 1px; margin: 18px 0 10px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .form-group { margin-bottom: 14px; }
  .form-group label {
    display: block; font-size: 13px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 4px; letter-spacing: 0.3px;
  }
  .form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 12px 14px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 10px; color: var(--text-primary); font-size: 16px;
    outline: none; transition: border-color 0.2s;
    -webkit-appearance: none; appearance: none;
  }
  .form-group textarea {
    resize: vertical; min-height: 60px; font-family: inherit;
  }
  .form-group select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%238892a8'%3E%3Cpath d='M6 8L0 0h12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center; padding-right: 38px;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
  }
  .form-row { display: flex; gap: 10px; }
  .form-row .form-group { flex: 1; }
  .form-row-3 { display: flex; gap: 10px; }
  .form-row-3 .form-group { flex: 1; }

  /* Sex toggle */
  .sex-toggle { display: flex; gap: 6px; flex-wrap: wrap; }
  .sex-toggle button {
    flex: 1 1 auto; min-width: 80px; padding: 10px 6px; border-radius: 10px; font-size: 13px; font-weight: 700;
    cursor: pointer; border: 1px solid var(--border); background: var(--bg-secondary);
    color: var(--text-secondary); transition: all 0.2s; min-height: 44px;
    -webkit-tap-highlight-color: rgba(59,130,246,0.15);
  }
  .sex-toggle button.active-male { background: rgba(59,130,246,0.2); border-color: var(--accent-blue); color: var(--accent-blue); }
  .sex-toggle button.active-female { background: rgba(236,72,153,0.2); border-color: var(--accent-pink); color: var(--accent-pink); }
  .sex-toggle button.active-castrated { background: rgba(6,182,212,0.2); border-color: var(--accent-cyan); color: var(--accent-cyan); }
  .sex-toggle button.active-spayed { background: rgba(249,115,22,0.2); border-color: var(--accent-orange); color: var(--accent-orange); }
  .sex-toggle button.active-unknown { background: rgba(139,92,246,0.2); border-color: var(--accent-purple); color: var(--accent-purple); }

  .btn-start {
    width: 100%; padding: 16px;
    background: linear-gradient(135deg, var(--accent-blue), #2563eb);
    color: white; font-size: 18px; font-weight: 700;
    border: none; border-radius: 12px; cursor: pointer; margin-top: 16px;
    min-height: 54px;
  }
  .btn-start:active { opacity: 0.8; }

  /* ===== DRUG PREP SCREEN ===== */
  #drugPrepScreen {
    position: fixed; inset: 0; z-index: 999;
    background: var(--bg-primary);
    display: none; align-items: flex-start; justify-content: center;
    overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 20px;
  }
  .prep-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 20px; padding: 24px 28px;
    width: 940px; max-width: 98vw;
  }
  .prep-patient-bar {
    display: flex; align-items: center; gap: 16px;
    background: var(--bg-secondary); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;
    font-size: 14px; font-weight: 600;
  }
  .prep-patient-bar .species-emoji { font-size: 24px; }
  .prep-patient-bar .weight-badge {
    background: rgba(59,130,246,0.15); padding: 4px 12px; border-radius: 8px;
    color: var(--accent-blue); font-weight: 700;
  }
  .prep-category {
    margin-bottom: 14px;
  }
  .prep-category-title {
    display: flex; align-items: center; gap: 8px; cursor: pointer;
    font-size: 14px; font-weight: 700; color: var(--accent-cyan);
    padding: 8px 12px; background: rgba(6,182,212,0.08); border-radius: 10px;
    margin-bottom: 8px; user-select: none;
  }
  .prep-category-title .arrow { transition: transform 0.2s; }
  .prep-category-title.collapsed .arrow { transform: rotate(-90deg); }
  .prep-drug-list { display: flex; flex-direction: column; gap: 6px; }
  .prep-drug-list.hidden { display: none; }
  .prep-drug-row {
    display: flex; align-items: center; gap: 8px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 12px; transition: border-color 0.2s;
  }
  .prep-drug-row.checked { border-color: var(--accent-green); background: rgba(16,185,129,0.05); }
  .prep-drug-row input[type="checkbox"] {
    width: 22px; height: 22px; accent-color: var(--accent-green);
    flex-shrink: 0; cursor: pointer;
  }
  .prep-drug-name { font-size: 14px; font-weight: 700; min-width: 130px; }
  .prep-drug-dose-range { font-size: 11px; color: var(--text-secondary); min-width: 90px; }
  .prep-drug-input {
    width: 70px; padding: 6px 8px; font-size: 14px; font-weight: 700;
    background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;
    color: var(--accent-yellow); text-align: center; outline: none;
    -webkit-appearance: none; appearance: none;
  }
  .prep-drug-input:focus { border-color: var(--accent-blue); }
  .prep-drug-unit { font-size: 12px; color: var(--text-secondary); min-width: 40px; }
  .prep-drug-calc {
    font-size: 16px; font-weight: 800; color: var(--accent-green);
    min-width: 80px; text-align: right;
  }
  .prep-drug-calc .calc-detail { font-size: 10px; color: var(--text-secondary); font-weight: 400; }
  .prep-drug-route {
    font-size: 10px; font-weight: 700; padding: 3px 8px; border-radius: 6px;
    background: rgba(139,92,246,0.15); color: var(--accent-purple);
    text-transform: uppercase; min-width: 30px; text-align: center;
  }
  .btn-prep-done {
    width: 100%; padding: 16px;
    background: linear-gradient(135deg, var(--accent-green), #059669);
    color: white; font-size: 18px; font-weight: 700;
    border: none; border-radius: 12px; cursor: pointer; margin-top: 16px;
    min-height: 54px;
  }
  .btn-prep-done:active { opacity: 0.8; }
  .btn-prep-skip {
    display: block; width: 100%; text-align: center; padding: 10px;
    color: var(--text-muted); font-size: 13px; cursor: pointer;
    background: none; border: none; margin-top: 4px;
  }
  .btn-prep-skip:active { color: var(--text-secondary); }

  /* ===== MAIN LAYOUT ===== */
  #mainApp { display: none; height: 100vh; }
  .app-layout { display: flex; height: 100%; }
  .left-panel {
    width: 65%; padding: 10px;
    display: flex; flex-direction: column; gap: 8px;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
  }
  .right-panel {
    width: 35%; padding: 10px 10px 10px 0;
    display: flex; flex-direction: column; gap: 8px;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
  }

  /* ===== HEADER ===== */
  .patient-header {
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 7px 14px; flex-shrink: 0;
  }
  .patient-header .hdr-item { white-space: nowrap; }
  .patient-header .label { font-size: 10px; color: var(--text-muted); letter-spacing: 0.5px; }
  .patient-header .value { font-size: 14px; font-weight: 700; }
  .patient-header .divider { width: 1px; height: 26px; background: var(--border); }
  .elapsed-badge {
    margin-left: auto; background: var(--accent-blue);
    padding: 5px 12px; border-radius: 20px;
    font-size: 12px; font-weight: 700; white-space: nowrap;
  }
  .procedure-badge {
    background: rgba(139,92,246,0.2); border: 1px solid var(--accent-purple);
    padding: 4px 10px; border-radius: 8px;
    font-size: 11px; font-weight: 600; color: var(--accent-purple);
    max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .notes-badge {
    background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.4);
    padding: 4px 10px; border-radius: 8px;
    font-size: 11px; font-weight: 600; color: var(--accent-yellow);
    max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    cursor: pointer;
  }

  /* ===== VITAL BIG DISPLAY ===== */
  .vitals-grid {
    display: grid; grid-template-columns: repeat(3, 1fr);
    gap: 8px; flex-shrink: 0;
  }
  .vital-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 12px; padding: 8px 12px; text-align: center;
    position: relative; transition: border-color 0.3s;
  }
  .vital-card .vital-label { font-size: 11px; font-weight: 700; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 1px; }
  .vital-card .vital-value { font-size: 32px; font-weight: 800; line-height: 1.1; font-variant-numeric: tabular-nums; }
  .vital-card .vital-unit { font-size: 11px; color: var(--text-secondary); }
  .vital-card .vital-indicator { position: absolute; top: 8px; right: 10px; width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); }
  .vital-card.alert { border-color: var(--accent-red); animation: alertPulse 1s infinite; }
  .vital-card.alert .vital-value { color: var(--accent-red) !important; }
  .vital-card.alert .vital-indicator { background: var(--accent-red); }
  @keyframes alertPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.3); } 50% { box-shadow: 0 0 20px 4px rgba(239,68,68,0.2); } }
  .vital-hr .vital-value { color: var(--hr-color); }
  .vital-spo2 .vital-value { color: var(--spo2-color); }
  .vital-rr .vital-value { color: var(--rr-color); }
  .vital-etco2 .vital-value { color: var(--etco2-color); }
  .vital-bp .vital-value { color: var(--bp-color); }
  .vital-temp .vital-value { color: var(--temp-color); }
  .vital-bp { grid-column: 1 / -1; }
  .bp-detail { display: flex; gap: 12px; justify-content: center; align-items: baseline; font-size: 34px; font-weight: 800; }
  .bp-detail .bp-slash { color: var(--text-muted); font-size: 24px; font-weight: 400; }
  .bp-detail .bp-mean { font-size: 22px; font-weight: 700; color: var(--text-secondary); margin-left: 4px; }

  /* ===== MANUAL VITAL INPUT ===== */
  .manual-vitals-row {
    display: flex; gap: 4px; align-items: flex-end; flex-shrink: 0;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 10px; padding: 8px 10px;
  }
  .mv-field { flex: 1; min-width: 0; }
  .mv-field label { display: block; font-size: 9px; color: var(--text-muted); font-weight: 700; letter-spacing: 0.5px; margin-bottom: 2px; text-align: center; }
  .mv-field input {
    width: 100%; padding: 6px 2px; font-size: 16px; font-weight: 700;
    background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 6px;
    color: var(--text-primary); text-align: center; outline: none;
    -webkit-appearance: none; appearance: none;
  }
  .mv-field input:focus { border-color: var(--accent-blue); }
  .mv-field input::placeholder { color: var(--text-muted); font-size: 12px; font-weight: 400; }
  .btn-manual-apply {
    padding: 6px 10px; min-width: 56px; min-height: 36px;
    background: var(--accent-green); border: none; border-radius: 8px;
    color: white; font-size: 11px; font-weight: 700; cursor: pointer;
    white-space: nowrap; flex-shrink: 0;
  }
  .btn-manual-apply:active { opacity: 0.8; }

  /* ===== CHART ===== */
  .chart-container { flex: 1; min-height: 160px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; position: relative; }

  /* ===== CAPTURE BUTTON ===== */
  .capture-row { display: flex; gap: 10px; flex-shrink: 0; }
  .btn-capture {
    flex: 1; padding: 14px;
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    border: none; border-radius: 14px; color: white; font-size: 18px; font-weight: 800;
    cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
    transition: transform 0.1s; position: relative; overflow: hidden; min-height: 56px;
  }
  .btn-capture:active { transform: scale(0.97); }
  .btn-capture .icon { font-size: 24px; }
  .btn-capture.capturing { background: linear-gradient(135deg, #7c3aed, #6d28d9); pointer-events: none; }

  /* ===== RIGHT PANEL ===== */
  .panel-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
  .panel-title { font-size: 11px; font-weight: 700; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }

  /* Timer */
  .timer-bar-wrap { height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden; margin-bottom: 2px; }
  .timer-bar { height: 100%; width: 100%; border-radius: 4px; background: var(--accent-green); transition: width 1s linear, background 0.5s; }
  .timer-bar.warning { background: var(--accent-yellow); }
  .timer-bar.critical { background: var(--accent-orange); }
  .timer-bar.danger { background: var(--accent-red); }
  .timer-text { text-align: center; font-size: 20px; font-weight: 800; font-variant-numeric: tabular-nums; }
  .announce-row { display: flex; gap: 6px; margin-top: 6px; }
  .btn-announce { flex: 1; padding: 10px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 13px; font-weight: 700; cursor: pointer; min-height: 44px; transition: background 0.2s; }
  .btn-announce:active { background: var(--bg-card-hover); }
  .btn-announce.active { background: var(--accent-blue); border-color: var(--accent-blue); }
  .announce-status { font-size: 11px; color: var(--text-secondary); margin-top: 3px; text-align: center; }

  /* CRI */
  .cri-select { width: 100%; padding: 10px 38px 10px 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 13px; margin-bottom: 8px; outline: none; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%238892a8'%3E%3Cpath d='M6 8L0 0h12z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; }
  .cri-control { display: flex; align-items: center; gap: 6px; }
  .cri-btn-group { display: flex; flex-direction: column; gap: 3px; }
  .cri-btn { width: 48px; height: 40px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 18px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 40px; }
  .cri-btn:active { background: var(--accent-blue); border-color: var(--accent-blue); }
  .cri-btn.fine { font-size: 13px; color: var(--text-secondary); height: 30px; min-height: 30px; }
  .cri-display { flex: 1; text-align: center; }
  .cri-display .rate { font-size: 26px; font-weight: 800; }
  .cri-display .rate-unit { font-size: 11px; color: var(--text-secondary); }
  .cri-display .converted { font-size: 15px; font-weight: 700; color: var(--accent-cyan); margin-top: 1px; }
  .cri-display .converted-unit { font-size: 10px; color: var(--text-secondary); }

  /* Events */
  .event-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
  .btn-event { padding: 10px 4px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 12px; font-weight: 700; cursor: pointer; text-align: center; min-height: 44px; transition: all 0.2s; }
  .btn-event:active { transform: scale(0.95); }
  .btn-event.recorded { background: rgba(16,185,129,0.15); border-color: var(--accent-green); color: var(--accent-green); }
  .btn-event .event-time { display: block; font-size: 9px; color: var(--text-secondary); margin-top: 1px; }
  .btn-event[data-cat="procedure"] { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); }
  .btn-event[data-cat="procedure"].recorded { background: rgba(245,158,11,0.25); border-color: var(--accent-yellow); color: var(--accent-yellow); }
  .btn-event[data-cat="airway"] { background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.3); }
  .btn-event[data-cat="airway"].recorded { background: rgba(16,185,129,0.2); border-color: var(--accent-green); color: var(--accent-green); }

  /* Drug admin */
  .drug-admin-section { margin-top: 6px; }
  .drug-admin-row { display: flex; gap: 6px; align-items: center; }
  .drug-admin-row select, .drug-admin-row input {
    padding: 8px 10px; background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text-primary); font-size: 13px; outline: none;
    -webkit-appearance: none; appearance: none;
  }
  .drug-admin-row select { flex: 2; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='%238892a8'%3E%3Cpath d='M5 6L0 0h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; padding-right: 24px; }
  .drug-admin-row input { flex: 1; }
  .btn-drug-add { padding: 8px 14px; background: var(--accent-purple); border: none; border-radius: 8px; color: white; font-size: 13px; font-weight: 700; cursor: pointer; white-space: nowrap; min-height: 36px; }
  .btn-drug-add:active { opacity: 0.8; }

  /* Emergency */
  .emerg-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
  .btn-emerg { padding: 8px 6px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.3); border-radius: 10px; color: var(--text-primary); cursor: pointer; text-align: center; min-height: 44px; transition: all 0.15s; }
  .btn-emerg:active { transform: scale(0.95); background: rgba(239,68,68,0.2); }
  .btn-emerg .drug-name { font-size: 11px; font-weight: 700; }
  .btn-emerg .drug-dose { font-size: 15px; font-weight: 800; color: var(--accent-red); margin: 1px 0; }
  .btn-emerg .drug-detail { font-size: 8px; color: var(--text-secondary); }
  .btn-emerg.used { background: rgba(239,68,68,0.25); border-color: var(--accent-red); }

  /* Voice */
  .btn-voice { width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 10px; color: var(--text-primary); font-size: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; min-height: 44px; }
  .btn-voice.recording { background: rgba(239,68,68,0.15); border-color: var(--accent-red); color: var(--accent-red); animation: voicePulse 1.5s infinite; }
  @keyframes voicePulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.3); } 50% { box-shadow: 0 0 15px 3px rgba(239,68,68,0.15); } }
  .voice-log { max-height: 50px; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-top: 4px; font-size: 11px; color: var(--text-secondary); line-height: 1.4; }
  .voice-log p { padding: 1px 0; border-bottom: 1px solid var(--border); }

  /* Event Log */
  .event-log { max-height: 120px; overflow-y: auto; -webkit-overflow-scrolling: touch; font-size: 11px; line-height: 1.5; color: var(--text-secondary); }
  .event-log .log-entry { padding: 2px 0; border-bottom: 1px solid rgba(42,53,80,0.5); cursor: pointer; display: flex; align-items: flex-start; gap: 4px; }
  .event-log .log-entry:active { background: var(--bg-card-hover); }
  .event-log .log-time { color: var(--accent-cyan); font-weight: 600; white-space: nowrap; flex-shrink: 0; }
  .event-log .log-thumb { width: 36px; height: 27px; border-radius: 3px; object-fit: cover; flex-shrink: 0; }
  .event-log .log-text { flex: 1; min-width: 0; }
  .event-log .log-note { color: var(--accent-yellow); font-style: italic; font-size: 10px; display: block; }

  /* Log edit modal */
  .log-edit-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1500; animation: fadeIn 0.2s; }
  .log-edit-popup {
    background: var(--bg-card); border: 1px solid var(--accent-cyan); border-radius: 16px;
    padding: 20px; max-width: 520px; width: 92%;
  }
  .log-edit-popup h3 { color: var(--accent-cyan); margin-bottom: 10px; font-size: 14px; }
  .log-edit-popup .log-edit-img { max-width: 100%; border-radius: 8px; margin-bottom: 10px; }
  .log-edit-popup .log-edit-text { font-size: 12px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.5; }
  .log-edit-popup textarea {
    width: 100%; padding: 10px; min-height: 60px; resize: vertical;
    background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;
    color: var(--text-primary); font-size: 14px; font-family: inherit; outline: none;
  }
  .log-edit-popup .btn-row { display: flex; gap: 8px; margin-top: 10px; }
  .log-edit-popup .btn-row button {
    flex: 1; padding: 10px; border: none; border-radius: 8px;
    font-weight: 700; cursor: pointer; min-height: 44px; font-size: 14px;
  }
  .log-edit-popup .btn-save { background: var(--accent-cyan); color: var(--bg-primary); }
  .log-edit-popup .btn-cancel { background: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border); }

  /* Alert */
  .alert-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 2000; animation: fadeIn 0.2s; }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .alert-box { background: var(--bg-card); border: 2px solid var(--accent-red); border-radius: 20px; padding: 28px 36px; text-align: center; max-width: 400px; animation: alertBounce 0.3s; }
  @keyframes alertBounce { 0% { transform: scale(0.8); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  .alert-box .alert-icon { font-size: 44px; margin-bottom: 10px; }
  .alert-box .alert-title { font-size: 20px; font-weight: 800; color: var(--accent-red); margin-bottom: 6px; }
  .alert-box .alert-msg { font-size: 15px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
  .alert-box .btn-dismiss { padding: 12px 36px; background: var(--accent-red); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 700; cursor: pointer; min-height: 44px; }

  /* Notes popup */
  .notes-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 1500; animation: fadeIn 0.2s; }
  .notes-popup { background: var(--bg-card); border: 1px solid var(--accent-yellow); border-radius: 16px; padding: 24px; max-width: 500px; width: 90%; }
  .notes-popup h3 { color: var(--accent-yellow); margin-bottom: 10px; font-size: 16px; }
  .notes-popup p { color: var(--text-secondary); font-size: 14px; line-height: 1.6; white-space: pre-wrap; }
  .notes-popup button { margin-top: 14px; padding: 10px 30px; background: var(--accent-yellow); border: none; border-radius: 8px; color: var(--bg-primary); font-weight: 700; cursor: pointer; }

  /* ===== SETTINGS SCREEN (Tabs: Monitor + Drug Master) ===== */
  #settingsScreen {
    position: fixed; inset: 0; z-index: 1100;
    background: var(--bg-primary);
    display: none; flex-direction: column;
    overflow: hidden;
  }
  .settings-header {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 20px; background: var(--bg-card);
    border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .settings-header h2 {
    font-size: 18px; font-weight: 700;
    background: linear-gradient(135deg, var(--accent-yellow), var(--accent-orange));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    flex: 1;
  }
  .settings-header .btn-settings-close {
    padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text-secondary); font-size: 13px; font-weight: 600;
    cursor: pointer; min-height: 38px;
  }
  .settings-header .btn-settings-close:active { background: var(--bg-card-hover); }

  /* Settings Tab Bar */
  .settings-tab-bar {
    display: flex; gap: 0; background: var(--bg-card);
    border-bottom: 2px solid var(--border); flex-shrink: 0; padding: 0 20px;
  }
  .settings-tab {
    padding: 12px 24px; font-size: 14px; font-weight: 700;
    color: var(--text-muted); cursor: pointer;
    border: none; background: none; border-bottom: 3px solid transparent;
    margin-bottom: -2px; transition: all 0.2s; min-height: 44px;
  }
  .settings-tab:active { opacity: 0.7; }
  .settings-tab.active {
    color: var(--accent-cyan);
    border-bottom-color: var(--accent-cyan);
    background: rgba(6,182,212,0.05);
  }
  .settings-tab-content { display: none; flex: 1; min-height: 0; overflow: hidden; }
  .settings-tab-content.active { display: flex; flex-direction: column; }
  .calib-body, .settings-tab-body {
    display: flex; flex: 1; min-height: 0; overflow: hidden;
  }
  .calib-left {
    flex: 1; display: flex; flex-direction: column; padding: 12px;
    min-width: 0;
  }
  .calib-right {
    width: 280px; padding: 12px; overflow-y: auto; -webkit-overflow-scrolling: touch;
    border-left: 1px solid var(--border); flex-shrink: 0;
  }
  .calib-image-area {
    flex: 1; position: relative; background: var(--bg-secondary);
    border: 2px dashed var(--border); border-radius: 12px;
    overflow: hidden; min-height: 200px;
    display: flex; align-items: center; justify-content: center;
  }
  .calib-image-area.has-image { border-style: solid; border-color: var(--accent-cyan); }
  .calib-image-area img {
    width: 100%; height: 100%; object-fit: contain; display: block;
  }
  .calib-placeholder {
    text-align: center; color: var(--text-muted); padding: 20px;
  }
  .calib-placeholder .icon { font-size: 48px; margin-bottom: 10px; }
  .calib-placeholder p { font-size: 13px; line-height: 1.6; }
  .btn-calib-capture {
    margin-top: 10px; padding: 14px;
    background: linear-gradient(135deg, var(--accent-orange), #ea580c);
    border: none; border-radius: 12px; color: white;
    font-size: 16px; font-weight: 700; cursor: pointer;
    min-height: 50px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .btn-calib-capture:active { opacity: 0.8; }

  /* Bounding boxes overlay */
  .calib-overlay {
    position: absolute; inset: 0; cursor: crosshair;
  }
  .calib-box {
    position: absolute; border: 2px solid; border-radius: 4px;
    cursor: move; touch-action: none; min-width: 40px; min-height: 30px;
    display: flex; align-items: flex-start; justify-content: flex-start;
  }
  .calib-box .box-label {
    position: absolute; top: -22px; left: 0;
    font-size: 11px; font-weight: 800; padding: 2px 8px;
    border-radius: 4px 4px 0 0; white-space: nowrap;
    cursor: pointer;
  }
  .calib-box .box-delete {
    position: absolute; top: -22px; right: 0;
    width: 20px; height: 20px; line-height: 20px; text-align: center;
    font-size: 12px; cursor: pointer; border-radius: 4px;
    background: rgba(239,68,68,0.8); color: white;
  }
  .calib-box .box-resize {
    position: absolute; bottom: -4px; right: -4px;
    width: 16px; height: 16px; border-radius: 3px;
    background: white; border: 2px solid; cursor: se-resize;
    touch-action: none;
  }
  .calib-box[data-param="HR"] { border-color: var(--hr-color); }
  .calib-box[data-param="HR"] .box-label { background: var(--hr-color); color: white; }
  .calib-box[data-param="HR"] .box-resize { border-color: var(--hr-color); }
  .calib-box[data-param="SPO2"] { border-color: var(--spo2-color); }
  .calib-box[data-param="SPO2"] .box-label { background: var(--spo2-color); color: white; }
  .calib-box[data-param="SPO2"] .box-resize { border-color: var(--spo2-color); }
  .calib-box[data-param="RR"] { border-color: var(--rr-color); }
  .calib-box[data-param="RR"] .box-label { background: var(--rr-color); color: white; }
  .calib-box[data-param="RR"] .box-resize { border-color: var(--rr-color); }
  .calib-box[data-param="BP"] { border-color: var(--bp-color); }
  .calib-box[data-param="BP"] .box-label { background: var(--bp-color); color: white; }
  .calib-box[data-param="BP"] .box-resize { border-color: var(--bp-color); }
  .calib-box[data-param="ETCO2"] { border-color: var(--etco2-color); }
  .calib-box[data-param="ETCO2"] .box-label { background: var(--etco2-color); color: white; }
  .calib-box[data-param="ETCO2"] .box-resize { border-color: var(--etco2-color); }
  .calib-box[data-param="TEMP"] { border-color: var(--temp-color); }
  .calib-box[data-param="TEMP"] .box-label { background: var(--temp-color); color: white; }
  .calib-box[data-param="TEMP"] .box-resize { border-color: var(--temp-color); }
  .calib-box[data-param="ISO"] { border-color: #94a3b8; }
  .calib-box[data-param="ISO"] .box-label { background: #94a3b8; color: white; }
  .calib-box[data-param="ISO"] .box-resize { border-color: #94a3b8; }

  /* Param select dropdown */
  .calib-param-select {
    position: absolute; z-index: 10; background: var(--bg-card);
    border: 1px solid var(--accent-cyan); border-radius: 10px;
    padding: 6px; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    min-width: 140px;
  }
  .calib-param-select button {
    display: block; width: 100%; padding: 10px 12px; text-align: left;
    background: none; border: none; color: var(--text-primary);
    font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px;
    min-height: 40px;
  }
  .calib-param-select button:active { background: var(--bg-card-hover); }
  .calib-param-select button .param-dot {
    display: inline-block; width: 10px; height: 10px; border-radius: 50%;
    margin-right: 8px; vertical-align: middle;
  }

  /* Right panel controls */
  .calib-section-title {
    font-size: 12px; font-weight: 700; color: var(--accent-cyan);
    letter-spacing: 0.5px; margin: 14px 0 8px; padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
  }
  .calib-section-title:first-child { margin-top: 0; }
  .calib-box-list { display: flex; flex-direction: column; gap: 6px; }
  .calib-box-item {
    display: flex; align-items: center; gap: 6px; padding: 8px 10px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; font-size: 12px; font-weight: 600;
  }
  .calib-box-item .param-dot {
    width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0;
  }
  .calib-box-item .param-name { flex: 1; }
  .calib-box-item .param-coords { color: var(--text-muted); font-size: 10px; }
  .btn-add-box {
    width: 100%; padding: 10px; margin-top: 8px;
    background: var(--bg-secondary); border: 1px dashed var(--accent-cyan);
    border-radius: 8px; color: var(--accent-cyan);
    font-size: 13px; font-weight: 600; cursor: pointer; min-height: 44px;
  }
  .btn-add-box:active { background: var(--bg-card-hover); }

  /* Profile section */
  .calib-profile-list { display: flex; flex-direction: column; gap: 6px; }
  .calib-profile-item {
    display: flex; align-items: center; gap: 6px; padding: 10px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; cursor: pointer; min-height: 44px;
  }
  .calib-profile-item:active { background: var(--bg-card-hover); }
  .calib-profile-item.active { border-color: var(--accent-green); background: rgba(16,185,129,0.08); }
  .calib-profile-item .profile-name { flex: 1; font-size: 13px; font-weight: 600; }
  .calib-profile-item .profile-count { font-size: 11px; color: var(--text-muted); }
  .calib-profile-item .profile-delete {
    width: 24px; height: 24px; line-height: 24px; text-align: center;
    border-radius: 6px; background: rgba(239,68,68,0.15); color: var(--accent-red);
    font-size: 12px; cursor: pointer; flex-shrink: 0;
  }
  .btn-save-profile {
    width: 100%; padding: 12px;
    background: linear-gradient(135deg, var(--accent-green), #059669);
    border: none; border-radius: 10px; color: white;
    font-size: 14px; font-weight: 700; cursor: pointer; margin-top: 8px;
    min-height: 44px;
  }
  .btn-save-profile:active { opacity: 0.8; }
  .calib-profile-name-input {
    width: 100%; padding: 10px 12px; margin-top: 8px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text-primary); font-size: 14px;
    outline: none; -webkit-appearance: none;
  }
  .calib-profile-name-input:focus { border-color: var(--accent-blue); }

  /* (Settings button is now .btn-settings-gear in title row) */

  /* ===== DRUG MASTER EDITOR ===== */
  .dm-editor {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
  .dm-toolbar {
    display: flex; align-items: center; gap: 12px; padding: 12px 20px;
    background: var(--bg-card); border-bottom: 1px solid var(--border); flex-shrink: 0;
  }
  .dm-toolbar label { font-size: 13px; font-weight: 700; color: var(--text-secondary); }
  .dm-toolbar select {
    padding: 8px 32px 8px 12px; background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600;
    -webkit-appearance: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%238892a8'%3E%3Cpath d='M6 8L0 0h12z'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 10px center;
  }
  .dm-toolbar .btn-dm-reset {
    margin-left: auto; padding: 8px 16px; background: rgba(239,68,68,0.1);
    border: 1px solid rgba(239,68,68,0.3); border-radius: 8px;
    color: var(--accent-red); font-size: 12px; font-weight: 600; cursor: pointer;
  }
  .dm-scroll {
    flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 12px 20px;
  }
  .dm-category {
    margin-bottom: 16px;
  }
  .dm-category-title {
    font-size: 13px; font-weight: 700; color: var(--accent-cyan);
    padding: 8px 12px; background: rgba(6,182,212,0.08); border-radius: 8px;
    margin-bottom: 6px; display: flex; align-items: center; gap: 8px;
  }
  .dm-drug-row {
    display: flex; align-items: center; gap: 6px; padding: 8px 10px;
    background: var(--bg-secondary); border: 1px solid var(--border);
    border-radius: 8px; margin-bottom: 4px; flex-wrap: wrap;
  }
  .dm-drug-row input, .dm-drug-row select {
    padding: 6px 8px; background: var(--bg-card); border: 1px solid var(--border);
    border-radius: 6px; color: var(--text-primary); font-size: 13px;
    outline: none; -webkit-appearance: none; appearance: none;
  }
  .dm-drug-row input:focus, .dm-drug-row select:focus { border-color: var(--accent-blue); }
  .dm-drug-name { width: 120px; font-weight: 700; }
  .dm-drug-conc { width: 60px; text-align: center; }
  .dm-drug-unit { width: 70px; font-size: 11px; }
  .dm-drug-dose { width: 65px; text-align: center; color: var(--accent-yellow); font-weight: 700; }
  .dm-drug-route { width: 65px; text-align: center; }
  .dm-field-label { font-size: 10px; color: var(--text-muted); font-weight: 600; }
  .dm-drug-actions {
    display: flex; flex-direction: column; gap: 2px; flex-shrink: 0; margin-left: auto;
  }
  .dm-drug-move {
    width: 26px; height: 20px; line-height: 20px; text-align: center;
    border-radius: 4px; background: rgba(59,130,246,0.1); color: var(--accent-blue);
    font-size: 10px; cursor: pointer; border: none;
    -webkit-tap-highlight-color: rgba(59,130,246,0.2);
  }
  .dm-drug-move:active { background: rgba(59,130,246,0.25); }
  .dm-drug-move:disabled { opacity: 0.2; pointer-events: none; }
  .dm-drug-delete {
    width: 28px; height: 28px; line-height: 28px; text-align: center;
    border-radius: 6px; background: rgba(239,68,68,0.1); color: var(--accent-red);
    font-size: 12px; cursor: pointer; border: none; flex-shrink: 0;
  }
  .dm-drug-delete:active { background: rgba(239,68,68,0.2); }
  .btn-dm-add {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    width: 100%; padding: 8px; margin-top: 4px;
    background: var(--bg-secondary); border: 1px dashed var(--accent-cyan);
    border-radius: 8px; color: var(--accent-cyan);
    font-size: 12px; font-weight: 600; cursor: pointer; min-height: 36px;
  }
  .btn-dm-add:active { background: var(--bg-card-hover); }
  .dm-save-bar {
    padding: 12px 20px; background: var(--bg-card); border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .btn-dm-save {
    width: 100%; padding: 14px;
    background: linear-gradient(135deg, var(--accent-green), #059669);
    border: none; border-radius: 10px; color: white;
    font-size: 16px; font-weight: 700; cursor: pointer; min-height: 48px;
  }
  .btn-dm-save:active { opacity: 0.8; }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  @media (min-width: 1024px) and (orientation: landscape) {
    .vital-card .vital-value { font-size: 36px; }
    .bp-detail { font-size: 36px; }
  }
  @media (max-height: 700px) {
    .vital-card { padding: 6px 10px; }
    .vital-card .vital-value { font-size: 28px; }
    .bp-detail { font-size: 28px; }
    .panel-section { padding: 8px; }
    .chart-container { min-height: 120px; }
  }

  /* ===== REPORT SCREEN ===== */
  #reportScreen {
    position: fixed; inset: 0; z-index: 1200;
    background: rgba(0,0,0,0.85);
    display: none; align-items: flex-start; justify-content: center;
    overflow-y: auto; -webkit-overflow-scrolling: touch;
    padding: 20px;
  }
  .report-wrapper {
    background: #fff; color: #1a1a1a; width: 210mm; max-width: 100%;
    margin: 0 auto; border-radius: 8px; overflow: hidden;
    box-shadow: 0 8px 40px rgba(0,0,0,0.5);
  }
  .report-actions {
    display: flex; gap: 12px; padding: 16px 24px;
    background: var(--bg-card); border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 5;
  }
  .report-actions button {
    padding: 10px 24px; border: none; border-radius: 8px;
    font-size: 15px; font-weight: 700; cursor: pointer; min-height: 44px;
  }
  .btn-report-print {
    background: linear-gradient(135deg, var(--accent-blue), #2563eb);
    color: white; flex: 1;
  }
  .btn-report-close {
    background: var(--bg-secondary); color: var(--text-primary); min-width: 100px;
  }
  .report-content {
    padding: 24px 32px;
    font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', 'Yu Gothic', sans-serif;
    font-size: 11px; line-height: 1.6;
  }
  .report-header {
    text-align: center; border-bottom: 2px solid #333; padding-bottom: 12px; margin-bottom: 16px;
  }
  .report-header h1 { font-size: 20px; margin-bottom: 4px; letter-spacing: 2px; }
  .report-header .report-subtitle { font-size: 12px; color: #666; }
  .report-patient-table {
    width: 100%; border-collapse: collapse; margin-bottom: 16px; font-size: 11px;
  }
  .report-patient-table td {
    border: 1px solid #ccc; padding: 4px 8px;
  }
  .report-patient-table .label-cell {
    background: #f0f0f0; font-weight: 700; width: 80px; white-space: nowrap;
  }
  .report-section-title {
    font-size: 13px; font-weight: 700; background: #333; color: #fff;
    padding: 4px 10px; margin: 16px 0 8px 0; border-radius: 3px;
  }
  .report-chart-img {
    width: 100%; max-height: 200px; object-fit: contain;
    border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;
  }
  .report-timeline {
    width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 8px;
  }
  .report-timeline th {
    background: #e8e8e8; border: 1px solid #ccc; padding: 3px 6px; text-align: left;
  }
  .report-timeline td {
    border: 1px solid #ccc; padding: 3px 6px;
  }
  .report-timeline tr:nth-child(even) td { background: #f8f8f8; }
  .report-drug-table {
    width: 100%; border-collapse: collapse; font-size: 10px; margin-bottom: 8px;
  }
  .report-drug-table th {
    background: #e8e8e8; border: 1px solid #ccc; padding: 3px 6px; text-align: left;
  }
  .report-drug-table td {
    border: 1px solid #ccc; padding: 3px 6px;
  }
  .report-drug-table tr:nth-child(even) td { background: #f8f8f8; }
  .report-vitals-table {
    width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 8px;
  }
  .report-vitals-table th {
    background: #e8e8e8; border: 1px solid #ccc; padding: 2px 4px; text-align: center;
    font-size: 9px;
  }
  .report-vitals-table td {
    border: 1px solid #ccc; padding: 2px 4px; text-align: center;
  }
  .report-vitals-table tr:nth-child(even) td { background: #f8f8f8; }
  .report-footer {
    margin-top: 24px; padding-top: 12px; border-top: 1px solid #ccc;
    display: flex; gap: 40px; justify-content: flex-end;
  }
  .report-sig-block {
    text-align: center; min-width: 140px;
  }
  .report-sig-line {
    border-bottom: 1px solid #333; height: 40px; margin-bottom: 4px;
  }
  .report-sig-label { font-size: 10px; color: #666; }
  .report-notes-area {
    width: 100%; min-height: 50px; border: 1px solid #ccc; border-radius: 3px;
    padding: 6px; margin-top: 4px; font-size: 10px; color: #444;
  }
  .btn-end-anesthesia {
    width: 100%; padding: 12px;
    background: linear-gradient(135deg, #dc2626, #991b1b);
    border: 2px solid #ef4444; border-radius: 10px;
    color: white; font-size: 16px; font-weight: 700;
    cursor: pointer; min-height: 48px;
    letter-spacing: 1px;
  }
  .btn-end-anesthesia:active { opacity: 0.8; }

  /* ===== PRINT STYLES ===== */
  @media print {
    body { overflow: visible !important; height: auto !important; background: white !important; }
    #startupScreen, #drugPrepScreen, #settingsScreen, #mainApp,
    #alertContainer, .report-actions { display: none !important; }
    #reportScreen {
      position: static !important; background: none !important;
      display: block !important; padding: 0 !important; overflow: visible !important;
    }
    .report-wrapper {
      box-shadow: none !important; border-radius: 0 !important;
      width: 100% !important; max-width: none !important;
    }
    .report-content { padding: 10mm 12mm !important; }
    .report-header h1 { font-size: 18pt !important; }
    .report-chart-img { max-height: 180px !important; }
    .report-section-title { background: #333 !important; color: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .report-patient-table .label-cell { background: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .report-timeline th, .report-drug-table th, .report-vitals-table th { background: #e8e8e8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .report-timeline tr:nth-child(even) td, .report-drug-table tr:nth-child(even) td, .report-vitals-table tr:nth-child(even) td { background: #f8f8f8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    @page { size: A4 portrait; margin: 8mm; }
  }
</style>
</head>
<body>

<!-- ========== STARTUP SCREEN ========== -->
<div id="startupScreen">
  <div class="startup-card">
    <div class="startup-title-row">
      <h1>ü©∫ VetAnes</h1>
      <button type="button" class="btn-settings-gear" onclick="document.getElementById('settingsScreen').style.display='flex'">‚öôÔ∏è</button>
    </div>
    <p class="sub">Áç£ÂåªÈ∫ªÈÖîÁÆ°ÁêÜ„Ç¢„Ç∑„Çπ„Çø„É≥„Éà</p>

    <!-- ÊñΩË°ìÊÉÖÂ†± -->
    <div class="form-section-title">ÊñΩË°ìÊÉÖÂ†±</div>
    <div class="form-row">
      <div class="form-group">
        <label>ÂÆüÊñΩÊó•</label>
        <input type="date" id="inputDate">
      </div>
      <div class="form-group">
        <label>Âü∑ÂàÄÂåª</label>
        <input type="text" id="inputSurgeon" placeholder="Âü∑ÂàÄÂåª">
      </div>
      <div class="form-group">
        <label>È∫ªÈÖîÊãÖÂΩì</label>
        <input type="text" id="inputAnesthetist" placeholder="È∫ªÈÖîÊãÖÂΩì">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label>„Ç™„ÉöÂÜÖÂÆπ / È∫ªÈÖîÁõÆÁöÑ</label>
        <input type="text" id="inputProcedure" placeholder="‰æã: ÈÅøÂ¶äÊâãË°ì„ÄÅËÖ´Áò§ÂàáÈô§">
      </div>
    </div>

    <!-- ÊÇ£ËÄÖÊÉÖÂ†± -->
    <div class="form-section-title">ÊÇ£ËÄÖÊÉÖÂ†±</div>
    <div class="form-row">
      <div class="form-group">
        <label>ÊÇ£ËÄÖID</label>
        <input type="text" id="inputId" placeholder="ID">
      </div>
      <div class="form-group">
        <label>ÊÇ£ËÄÖÂêç</label>
        <input type="text" id="inputName" placeholder="ÊÇ£ËÄÖÂêç">
      </div>
    </div>
    <div class="form-row-3">
      <div class="form-group">
        <label>ÂãïÁâ©Á®Æ</label>
        <select id="inputSpecies">
          <option value="dog">Áä¨</option>
          <option value="cat">Áå´</option>
          <option value="rabbit">„Ç¶„Çµ„ÇÆ</option>
          <option value="ferret">„Éï„Çß„É¨„ÉÉ„Éà</option>
          <option value="guinea_pig">„É¢„É´„É¢„ÉÉ„Éà</option>
          <option value="hamster">„Éè„É†„Çπ„Çø„Éº</option>
          <option value="bird">È≥•È°û</option>
          <option value="reptile">Áà¨Ëô´È°û</option>
          <option value="other">„Åù„ÅÆ‰ªñ</option>
        </select>
      </div>
      <div class="form-group">
        <label>‰ΩìÈáç (kg)</label>
        <input type="number" id="inputWeight" placeholder="kg" step="0.01" min="0.001">
      </div>
      <div class="form-group">
        <label>Âπ¥ÈΩ¢</label>
        <input type="text" id="inputAge" placeholder="‰æã: 5Ê≠≥">
      </div>
    </div>
    <div class="form-group">
      <label>ÊÄßÂà•</label>
      <div class="sex-toggle" id="sexToggle">
        <button type="button" data-sex="male" onclick="setSex('male')">‚ôÇ „Ç™„Çπ</button>
        <button type="button" data-sex="castrated" onclick="setSex('castrated')">‚ôÇ ÂéªÂã¢„Ç™„Çπ</button>
        <button type="button" data-sex="female" onclick="setSex('female')">‚ôÄ „É°„Çπ</button>
        <button type="button" data-sex="spayed" onclick="setSex('spayed')">‚ôÄ ÈÅøÂ¶ä„É°„Çπ</button>
        <button type="button" data-sex="unknown" onclick="setSex('unknown')">‰∏çÊòé</button>
      </div>
    </div>
    <div class="form-group">
      <label>ÂÇôËÄÉÔºàÊó¢ÂæÄÊ≠¥„ÉªÊ≥®ÊÑè‰∫ãÈ†ÖÔºâ</label>
      <textarea id="inputNotes" placeholder="„Ç¢„É¨„É´„ÇÆ„Éº„ÄÅÊó¢ÂæÄÊ≠¥„ÄÅÁâπË®ò‰∫ãÈ†Ö„Å™„Å©"></textarea>
    </div>

    <button class="btn-start" onclick="startSession()">È∫ªÈÖî„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã</button>
  </div>
</div>

<!-- ========== SETTINGS SCREEN (Tabs) ========== -->
<div id="settingsScreen">
  <div class="settings-header">
    <h2>‚öôÔ∏è Ë®≠ÂÆö</h2>
    <button class="btn-settings-close" id="btnCloseSettings">‚úï Èñâ„Åò„Çã</button>
  </div>
  <div class="settings-tab-bar">
    <button class="settings-tab active" data-tab="tabMonitor" id="tabBtnMonitor">üìê „É¢„Éã„Çø„ÉºË®≠ÂÆö</button>
    <button class="settings-tab" data-tab="tabDrugMaster" id="tabBtnDrugMaster">üíä Ëñ¨Ââ§„Éû„Çπ„Çø</button>
    <button class="settings-tab" data-tab="tabApiSettings" id="tabBtnApi">üîë AIË™≠ÂèñË®≠ÂÆö</button>
  </div>

  <!-- Tab 1: Monitor Calibration -->
  <div class="settings-tab-content active" id="tabMonitor">
    <div class="calib-body">
      <div class="calib-left">
        <div class="calib-image-area" id="calibImageArea">
          <div class="calib-placeholder" id="calibPlaceholder">
            <div class="icon">üì∑</div>
            <p>„É¢„Éã„Çø„ÉºÁîªÈù¢„ÇíÊíÆÂΩ±„Åó„Å¶<br>Ë™≠Âèñ‰ΩçÁΩÆ„ÇíË®≠ÂÆö„Åó„Åæ„Åô</p>
            <p style="font-size:11px;color:var(--text-muted);margin-top:6px;">ÊíÆÂΩ±Âæå„ÄÅÊû†„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶<br>ÂêÑ„Éë„É©„É°„Éº„Çø„ÅÆË°®Á§∫‰ΩçÁΩÆ„ÇíÊåáÂÆö</p>
          </div>
          <img id="calibImage" style="display:none;" alt="Reference">
          <div class="calib-overlay" id="calibOverlay" style="display:none;"></div>
        </div>
        <button class="btn-calib-capture" onclick="captureCalibImage()">üì∏ „É¢„Éã„Çø„ÉºÁîªÈù¢„ÇíÊíÆÂΩ±Ôºà„É™„Éï„Ç°„É¨„É≥„ÇπÔºâ</button>
      </div>
      <div class="calib-right">
        <div class="calib-section-title">üìê Ë™≠Âèñ„Ç®„É™„Ç¢</div>
        <div class="calib-box-list" id="calibBoxList">
          <div style="color:var(--text-muted);font-size:12px;padding:8px;">„É™„Éï„Ç°„É¨„É≥„ÇπÁîªÂÉè„ÇíÊíÆÂΩ±Âæå„ÄÅ<br>Êû†„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        </div>
        <button class="btn-add-box" id="btnAddBox" onclick="addCalibBox()" style="display:none;">Ôºã Ë™≠ÂèñÊû†„ÇíËøΩÂä†</button>

        <div class="calib-section-title">üíæ „Éó„É≠„Éï„Ç°„Ç§„É´</div>
        <input class="calib-profile-name-input" id="calibProfileName" placeholder="‰æã: Á¨¨1„Ç™„ÉöÂÆ§„ÉªÊó•Êú¨ÂÖâÈõª">
        <button class="btn-save-profile" onclick="saveCalibProfile()">üíæ „Éó„É≠„Éï„Ç°„Ç§„É´„Çí‰øùÂ≠ò</button>
        <div class="calib-profile-list" id="calibProfileList" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- Tab 2: Drug Master Editor -->
  <div class="settings-tab-content" id="tabDrugMaster">
    <div class="dm-editor">
      <div class="dm-toolbar">
        <label>ÂãïÁâ©Á®Æ:</label>
        <select id="dmSpeciesSelect">
          <option value="dog">üêï Áä¨</option>
          <option value="cat">üêà Áå´</option>
          <option value="rabbit">üêá „Ç¶„Çµ„ÇÆ</option>
          <option value="ferret">ü¶ä „Éï„Çß„É¨„ÉÉ„Éà</option>
          <option value="guinea_pig">üêπ „É¢„É´„É¢„ÉÉ„Éà</option>
          <option value="hamster">üêπ „Éè„É†„Çπ„Çø„Éº</option>
          <option value="bird">üê¶ È≥•È°û</option>
          <option value="reptile">ü¶é Áà¨Ëô´È°û</option>
        </select>
        <button class="btn-dm-reset" id="btnDmReset">üîÑ „Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åô</button>
      </div>
      <div class="dm-scroll" id="dmDrugListArea"></div>
      <div class="dm-save-bar">
        <button class="btn-dm-save" id="btnDmSave">üíæ Ëñ¨Ââ§„Éû„Çπ„Çø„Çí‰øùÂ≠ò</button>
      </div>
    </div>
  </div>

  <!-- Tab 3: API Settings -->
  <div class="settings-tab-content" id="tabApiSettings">
    <div style="padding:20px; max-width:560px; margin:0 auto;">
      <div style="text-align:center; margin-bottom:20px;">
        <div style="font-size:40px; margin-bottom:8px;">ü§ñ</div>
        <h3 style="font-size:16px; margin-bottom:4px;">AI „É¢„Éã„Çø„ÉºË™≠ÂèñË®≠ÂÆö</h3>
        <p style="font-size:12px; color:var(--text-secondary);">Gemini API„Çí‰Ωø„Å£„Å¶„É¢„Éã„Çø„ÉºÁîªÂÉè„Åã„Çâ„Éê„Ç§„Çø„É´„ÇíËá™ÂãïË™≠Âèñ„Åó„Åæ„Åô</p>
      </div>

      <div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:10px; padding:16px; margin-bottom:16px;">
        <label style="font-size:13px; font-weight:600; color:var(--text-primary); display:block; margin-bottom:8px;">üîë Google AI (Gemini) API „Ç≠„Éº</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="password" id="inputApiKey" placeholder="AIzaSy..." style="flex:1; padding:10px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:14px; font-family:monospace;">
          <button type="button" onclick="toggleApiKeyVisibility()" style="width:44px; height:44px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text-secondary); font-size:18px; cursor:pointer;" id="btnToggleKey">üëÅ</button>
        </div>
        <p style="font-size:11px; color:var(--text-muted); margin-top:6px;">‚Äª „Ç≠„Éº„ÅØ„Åì„ÅÆÁ´ØÊú´„ÅÆ„Éñ„É©„Ç¶„Ç∂„Å´„ÅÆ„Åø‰øùÂ≠ò„Åï„Çå„Åæ„ÅôÔºàÂ§ñÈÉ®ÈÄÅ‰ø°„ÅØAPIÈÄö‰ø°„ÅÆ„ÅøÔºâ</p>
      </div>

      <div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:10px; padding:16px; margin-bottom:16px;">
        <label style="font-size:13px; font-weight:600; color:var(--text-primary); display:block; margin-bottom:8px;">üß† „É¢„Éá„É´ÈÅ∏Êäû</label>
        <select id="selectApiModel" style="width:100%; padding:10px 12px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text-primary); font-size:14px;">
          <option value="gemini-flash">Gemini 2.0 FlashÔºàÈ´òÈÄü„ÉªÊúÄÂÆâ ‚âà¬•0.1/ÂõûÔºâÊé®Â•®</option>
          <option value="gemini-pro">Gemini 2.5 ProÔºàÊúÄÈ´òÁ≤æÂ∫¶ ‚âà¬•1/ÂõûÔºâ</option>
        </select>
      </div>

      <div style="background:var(--bg-secondary); border:1px solid var(--border); border-radius:10px; padding:16px; margin-bottom:16px;">
        <label style="font-size:13px; font-weight:600; color:var(--text-primary); display:block; margin-bottom:8px;">üìã Âãï‰Ωú„É¢„Éº„Éâ</label>
        <div style="display:flex; gap:8px;">
          <button type="button" class="api-mode-btn active" id="btnModeAI" onclick="setApiMode('ai')" style="flex:1; padding:10px; background:rgba(16,185,129,0.15); border:2px solid var(--accent-green); border-radius:8px; color:var(--accent-green); font-size:13px; font-weight:700; cursor:pointer;">ü§ñ AIË™≠Âèñ</button>
          <button type="button" class="api-mode-btn" id="btnModeDemo" onclick="setApiMode('demo')" style="flex:1; padding:10px; background:var(--bg-card); border:2px solid var(--border); border-radius:8px; color:var(--text-secondary); font-size:13px; font-weight:600; cursor:pointer;">üé≤ „Éá„É¢„É¢„Éº„Éâ</button>
        </div>
        <p style="font-size:11px; color:var(--text-muted); margin-top:6px;" id="apiModeDesc">„É¢„Éã„Çø„ÉºÊíÆÂΩ±ÊôÇ„Å´AI„Åå„Éê„Ç§„Çø„É´ÂÄ§„ÇíË™≠„ÅøÂèñ„Çä„Åæ„ÅôÔºàAPI„Ç≠„ÉºÂøÖÈ†àÔºâ</p>
      </div>

      <button type="button" onclick="saveApiSettings()" style="width:100%; padding:14px; background:linear-gradient(135deg, var(--accent-green), #059669); border:none; border-radius:10px; color:white; font-size:16px; font-weight:700; cursor:pointer; min-height:48px;">üíæ APIË®≠ÂÆö„Çí‰øùÂ≠ò</button>

      <button type="button" onclick="testApiConnection()" id="btnTestApi" style="width:100%; padding:12px; margin-top:8px; background:var(--bg-secondary); border:1px solid var(--accent-blue); border-radius:10px; color:var(--accent-blue); font-size:14px; font-weight:600; cursor:pointer; min-height:44px;">üîç Êé•Á∂ö„ÉÜ„Çπ„Éà</button>
      <div id="apiTestResult" style="margin-top:8px; padding:10px; border-radius:8px; font-size:12px; display:none;"></div>

      <div style="margin-top:20px; padding:16px; background:rgba(59,130,246,0.08); border:1px solid rgba(59,130,246,0.2); border-radius:10px;">
        <div style="font-size:13px; font-weight:700; color:var(--accent-blue); margin-bottom:8px;">üí° API„Ç≠„Éº„ÅÆÂèñÂæóÊñπÊ≥ï</div>
        <ol style="font-size:11px; color:var(--text-secondary); padding-left:18px; line-height:1.8;">
          <li><a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent-blue);">aistudio.google.com/apikey</a> „Å´„Ç¢„ÇØ„Çª„Çπ</li>
          <li>Google„Ç¢„Ç´„Ç¶„É≥„Éà„Åß„É≠„Ç∞„Ç§„É≥</li>
          <li>„ÄåAPI„Ç≠„Éº„Çí‰ΩúÊàê„Äç„Çí„ÇØ„É™„ÉÉ„ÇØ</li>
          <li>ÁîüÊàê„Åï„Çå„Åü„Ç≠„ÉºÔºàAIzaSy...Ôºâ„Çí„Ç≥„Éî„Éº„Åó„Å¶‰∏ä„Å´Ë≤º„Çä‰ªò„Åë</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<!-- ========== DRUG PREPARATION SCREEN ========== -->
<div id="drugPrepScreen">
  <div class="prep-card">
    <h1 style="font-size:22px; font-weight:700; margin-bottom:4px; background:linear-gradient(135deg,var(--accent-green),var(--accent-cyan)); -webkit-background-clip:text; -webkit-text-fill-color:transparent;">üíâ Ëñ¨Ââ§Ê∫ñÂÇô„ÉÅ„Çß„ÉÉ„ÇØ„É™„Çπ„Éà</h1>
    <p class="sub" style="color:var(--text-secondary); margin-bottom:12px; font-size:13px;">‰ΩìÈáç„Åã„ÇâÊäï‰∏éÈáè„Éª„Ç∑„É™„É≥„Ç∏Ê∫ñÂÇôÈáè„ÇíËá™ÂãïË®àÁÆó</p>
    <div class="prep-patient-bar" id="prepPatientBar"></div>
    <div id="prepDrugList"></div>
    <button class="btn-prep-done" onclick="completeDrugPrep()">‚úÖ Ê∫ñÂÇôÂÆå‰∫Ü ‚Üí „É¢„Éã„Çø„É™„É≥„Ç∞ÈñãÂßã</button>
    <button class="btn-prep-skip" onclick="skipDrugPrep()">„Çπ„Ç≠„ÉÉ„ÉóÔºàÊ∫ñÂÇôÊ∏à„ÅøÔºâ</button>
  </div>
</div>

<!-- ========== MAIN APPLICATION ========== -->
<div id="mainApp">
  <div class="app-layout">
    <!-- LEFT PANEL -->
    <div class="left-panel">
      <div class="patient-header">
        <div class="hdr-item"><span class="label">ID</span><br><span class="value" id="dispId">-</span></div>
        <div class="divider"></div>
        <div class="hdr-item"><span class="label">ÊÇ£ËÄÖÂêç</span><br><span class="value" id="dispName">-</span></div>
        <div class="divider"></div>
        <div class="hdr-item"><span class="label">Á®ÆÂà•</span><br><span class="value" id="dispSpecies">-</span></div>
        <div class="divider"></div>
        <div class="hdr-item"><span class="label">‰ΩìÈáç</span><br><span class="value" id="dispWeight">-</span></div>
        <div class="divider"></div>
        <div class="hdr-item"><span class="label">ÊÄßÂà•</span><br><span class="value" id="dispSex">-</span></div>
        <div class="procedure-badge" id="dispProcedure" title="">-</div>
        <div class="notes-badge" id="dispNotes" onclick="showNotesPopup()" style="display:none;" title="">‚ö† ÂÇôËÄÉ„ÅÇ„Çä</div>
        <div class="elapsed-badge" id="dispElapsed">ÁµåÈÅé 00:00:00</div>
      </div>

      <div class="vitals-grid">
        <div class="vital-card vital-hr" id="vitalHR"><div class="vital-label">HR</div><div class="vital-value" id="valHR">--</div><div class="vital-unit">bpm</div><div class="vital-indicator"></div></div>
        <div class="vital-card vital-spo2" id="vitalSpO2"><div class="vital-label">SpO2</div><div class="vital-value" id="valSpO2">--</div><div class="vital-unit">%</div><div class="vital-indicator"></div></div>
        <div class="vital-card vital-rr" id="vitalRR"><div class="vital-label">RR</div><div class="vital-value" id="valRR">--</div><div class="vital-unit">/min</div><div class="vital-indicator"></div></div>
        <div class="vital-card vital-etco2" id="vitalEtCO2"><div class="vital-label">EtCO2</div><div class="vital-value" id="valEtCO2">--</div><div class="vital-unit">mmHg</div><div class="vital-indicator"></div></div>
        <div class="vital-card vital-temp" id="vitalTemp"><div class="vital-label">‰ΩìÊ∏©</div><div class="vital-value" id="valTemp">--</div><div class="vital-unit">‚ÑÉ</div><div class="vital-indicator"></div></div>
        <div class="vital-card vital-iso" id="vitalIso"><div class="vital-label">ISO</div><div class="vital-value" id="valIso">--</div><div class="vital-unit">%</div><div class="vital-indicator"></div></div>
        <div class="vital-card vital-bp" id="vitalBP"><div class="vital-label">Ë°ÄÂúß (Sys / Dia / Mean)</div><div class="bp-detail"><span id="valSys">--</span><span class="bp-slash">/</span><span id="valDia">--</span><span class="bp-mean">(<span id="valMean">--</span>)</span></div><div class="vital-unit">mmHg</div><div class="vital-indicator"></div></div>
      </div>

      <!-- Manual vital input row -->
      <div class="manual-vitals-row">
        <div class="mv-field"><label>HR</label><input type="number" id="mvHR" placeholder="--"></div>
        <div class="mv-field"><label>SpO2</label><input type="number" id="mvSpO2" placeholder="--"></div>
        <div class="mv-field"><label>RR</label><input type="number" id="mvRR" placeholder="--"></div>
        <div class="mv-field"><label>EtCO2</label><input type="number" id="mvEtCO2" placeholder="--"></div>
        <div class="mv-field"><label>Sys</label><input type="number" id="mvSys" placeholder="--"></div>
        <div class="mv-field"><label>Dia</label><input type="number" id="mvDia" placeholder="--"></div>
        <div class="mv-field"><label>T‚ÑÉ</label><input type="number" id="mvTemp" step="0.1" placeholder="--"></div>
        <div class="mv-field"><label>ISO</label><input type="number" id="mvIso" step="0.1" placeholder="--"></div>
        <button class="btn-manual-apply" onclick="applyManualVitals()">‚úèÔ∏è<br>ÈÅ©Áî®</button>
      </div>

      <div class="chart-container"><canvas id="vitalChart"></canvas></div>

      <div class="capture-row">
        <button class="btn-capture" id="btnCapture" onclick="handleCameraCapture()"><span class="icon">üì∏</span><span>„É¢„Éã„Çø„ÉºÊíÆÂΩ±</span></button>
      </div>
    </div>

    <!-- RIGHT PANEL -->
    <div class="right-panel">
      <!-- Timer -->
      <div class="panel-section">
        <div class="panel-title">‚è± „Çø„Ç§„Éû„Éº / „Ç¢„Éä„Ç¶„É≥„Çπ</div>
        <div class="timer-bar-wrap"><div class="timer-bar" id="timerBar"></div></div>
        <div class="timer-text" id="timerText">5:00</div>
        <div class="announce-row">
          <button class="btn-announce" id="btnInduction" onclick="startAnnounce('induction')">Â∞éÂÖ•</button>
          <button class="btn-announce" id="btnIncision" onclick="startAnnounce('incision')">ÂàáÁöÆ</button>
        </div>
        <div class="announce-status" id="announceStatus">-</div>
      </div>

      <!-- CRI -->
      <div class="panel-section">
        <div class="panel-title">üíä CRI Ë®àÁÆóÊ©ü</div>
        <select class="cri-select" id="criDrug" onchange="updateCRI()"></select>
        <div id="criCalcPanel" style="margin-top:8px;"></div>
      </div>

      <!-- Events -->
      <div class="panel-section">
        <div class="panel-title">üìã „Ç§„Éô„É≥„ÉàË®òÈå≤</div>
        <div class="event-grid">
          <button class="btn-event" data-event="ÂâçÊäï‰∏é" data-cat="procedure" onclick="recordEvent(this)">ÂâçÊäï‰∏é</button>
          <button class="btn-event" data-event="È∫ªÈÖîÂ∞éÂÖ•" data-cat="procedure" onclick="recordEvent(this)">È∫ªÈÖîÂ∞éÂÖ•</button>
          <button class="btn-event" data-event="ÂàáÁöÆ" data-cat="procedure" onclick="recordEvent(this)">ÂàáÁöÆ</button>
          <button class="btn-event" data-event="ÊåøÁÆ°" data-cat="airway" onclick="recordEvent(this)">ÊåøÁÆ°</button>
          <button class="btn-event" data-event="ÊäúÁÆ°" data-cat="airway" onclick="recordEvent(this)">ÊäúÁÆ°</button>
          <button class="btn-event" data-event="IPPV on" data-cat="airway" onclick="recordEvent(this)">IPPV on</button>
          <button class="btn-event" data-event="IPPV off" data-cat="airway" onclick="recordEvent(this)">IPPV off</button>
          <button class="btn-event" data-event="OPEÈñãÂßã" data-cat="procedure" onclick="recordEvent(this)">OPEÈñãÂßã</button>
          <button class="btn-event" data-event="OPEÁµÇ‰∫Ü" data-cat="procedure" onclick="recordEvent(this)">OPEÁµÇ‰∫Ü</button>
          <button class="btn-event" data-event="ÈñãÂâµ" data-cat="procedure" onclick="recordEvent(this)">ÈñãÂâµ</button>
          <button class="btn-event" data-event="ÈñâÂâµ" data-cat="procedure" onclick="recordEvent(this)">ÈñâÂâµ</button>
          <button class="btn-event" data-event="Ë¶öÈÜí" onclick="recordEvent(this)">Ë¶öÈÜí</button>
        </div>
      </div>

      <!-- Drug Administration -->
      <div class="panel-section">
        <div class="panel-title">üíâ Ëñ¨Ââ§Êäï‰∏éË®òÈå≤</div>
        <div class="drug-admin-row">
          <select id="drugAdminName"><option value="">Ëñ¨Ââ§ÈÅ∏Êäû</option>
            <option>„Éó„É≠„Éù„Éï„Ç©„Éº„É´</option><option>„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥</option>
            <option>„Éü„ÉÄ„Çæ„É©„É†</option><option>„Ç±„Çø„Éü„É≥</option>
            <option>„É°„Éá„Éà„Éü„Ç∏„É≥</option><option>„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´</option>
            <option>„Éï„Çß„É≥„Çø„Éã„É´</option><option>„É°„É≠„Ç≠„Ç∑„Ç´„É†</option>
            <option>„Çª„Éï„Ç°„Çæ„É™„É≥</option><option>„Éû„É≠„Éî„Çø„É≥„Éà</option>
            <option>‰π≥ÈÖ∏„É™„É≥„Ç≤„É´</option>
          </select>
          <input type="text" id="drugAdminDose" placeholder="Áî®Èáè">
          <select id="drugAdminRoute"><option>iv</option><option>im</option><option>sc</option><option>po</option><option>ip</option></select>
          <button class="btn-drug-add" onclick="recordDrugAdmin()">Ë®òÈå≤</button>
        </div>
      </div>

      <!-- Emergency -->
      <div class="panel-section">
        <div class="panel-title">üö® Á∑äÊÄ•Ëñ¨Ââ§</div>
        <div class="emerg-grid" id="emergGrid"></div>
      </div>

      <!-- Voice -->
      <div class="panel-section">
        <div class="panel-title">üéô Èü≥Â£∞ÂÖ•Âäõ</div>
        <button class="btn-voice" id="btnVoice" onclick="toggleVoice()"><span>üé§</span><span id="voiceLabel">Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã</span></button>
        <div class="voice-log" id="voiceLog"></div>
      </div>

      <!-- End Anesthesia -->
      <div class="panel-section">
        <button class="btn-end-anesthesia" onclick="endAnesthesia()">üèÅ È∫ªÈÖîÁµÇ‰∫Ü ‚Üí „É¨„Éù„Éº„Éà‰ΩúÊàê</button>
      </div>

      <!-- Log -->
      <div class="panel-section" style="flex:1; min-height:0;">
        <div class="panel-title">üìù Ë®òÈå≤„É≠„Ç∞</div>
        <div class="event-log" id="eventLog"></div>
      </div>
    </div>
  </div>
</div>

<div id="alertContainer"></div>

<!-- ========== REPORT SCREEN ========== -->
<div id="reportScreen">
  <div class="report-wrapper">
    <div class="report-actions">
      <button class="btn-report-print" onclick="printReport()">üñ® PDFÂá∫Âäõ / Âç∞Âà∑</button>
      <button class="btn-report-close" onclick="closeReport()">Èñâ„Åò„Çã</button>
    </div>
    <div class="report-content" id="reportContent">
      <!-- Generated dynamically by generateReport() -->
    </div>
  </div>
</div>

<script>
// ===================================================================
//  STATE
// ===================================================================
const state = {
  patient: { id:'', name:'', species:'dog', weight:0, age:'', sex:'', procedure:'', notes:'', surgeon:'', anesthetist:'', date:'' },
  sessionStart: null,
  vitals: { hr:[], spo2:[], rr:[], etco2:[], sys:[], dia:[], mean:[], temp:[] },
  timeLabels: [],
  timerInterval: null, timerRemaining: 300,
  announceType: null, announceStart: null, announceInterval: null,
  criRate: 1.0, voiceActive: false, recognition: null,
  events: [], elapsedInterval: null,
  selectedSex: '',
  // V4: Photo log
  capturedImages: [],  // { id, timestamp, dataUrl, notes }
  maxCapturedImages: 20,
  logEntries: {},      // logId -> { text, captureId, note }
  // V5: API settings
  apiKey: '',
  apiModel: 'gemini-flash',
  apiMode: 'ai',  // 'ai' or 'demo'
};

// ===================================================================
//  SPECIES CONFIG
// ===================================================================
const SPECIES_LABELS = {
  dog:'Áä¨', cat:'Áå´', rabbit:'„Ç¶„Çµ„ÇÆ', ferret:'„Éï„Çß„É¨„ÉÉ„Éà',
  guinea_pig:'„É¢„É´„É¢„ÉÉ„Éà', hamster:'„Éè„É†„Çπ„Çø„Éº', bird:'È≥•È°û', reptile:'Áà¨Ëô´È°û', other:'„Åù„ÅÆ‰ªñ'
};

const SPECIES_EMOJI = {
  dog:'üêï', cat:'üêà', rabbit:'üêá', ferret:'ü¶¶', guinea_pig:'üêπ',
  hamster:'üêπ', bird:'üê¶', reptile:'ü¶é', other:'üêæ'
};

// ===================================================================
//  DRUG MASTER DATA (Emergency + CRI)
// ===================================================================
const DRUG_MASTER_DEFAULT = {
  emergency: [
    { name:'„Ç¢„Éà„É≠„Éî„É≥', conc:0.5, unit:'mg/mL', dosePerKg:0.02, doseUnit:'mg/kg' },
    { name:'„Ç®„Éï„Çß„Éâ„É™„É≥', conc:4, unit:'mg/mL', dosePerKg:0.1, doseUnit:'mg/kg' },
    { name:'„Ç®„Éî„Éç„Éï„É™„É≥', conc:1, unit:'mg/mL', dosePerKg:0.01, doseUnit:'mg/kg' },
    { name:'„Éä„É≠„Ç≠„ÇΩ„É≥', conc:0.4, unit:'mg/mL', dosePerKg:0.04, doseUnit:'mg/kg' },
    { name:'„Éâ„Ç≠„Çµ„Éó„É©„É†', conc:20, unit:'mg/mL', dosePerKg:1, doseUnit:'mg/kg' },
    { name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, unit:'mg/mL', dosePerKg:2, doseUnit:'mg/kg' },
  ],
};

// ===================================================================
//  CRI MASTER DATA (per species, Excel worksheetÊ∫ñÊã†)
// ===================================================================
// calcType: 'simple' = mL/hrÁõ¥ÁµêÔºà„Éï„Çß„É≥„Çø„Éã„É´„Éª„Éó„É≠„Éù„Éï„Ç©„Éº„É´Á≠âÔºâ
//           'infusion' = Ëº∏Ê∂≤„Éë„ÉÉ„ÇØÊ∑∑Ê≥®ÊñπÂºèÔºà„Éâ„Éë„Éü„É≥„Éª„Éâ„Éñ„Çø„Éü„É≥„Éª„Ç±„Çø„Éü„É≥„Éª„É™„Éâ„Ç´„Ç§„É≥„Éª„É°„Éà„ÇØ„É≠„Éó„É©„Éü„ÉâÁ≠âÔºâ
// rateUnit: Êäï‰∏éÈÄüÂ∫¶„ÅÆÂçò‰Ωç
// conc: ÂéüÊ∂≤ÊøÉÂ∫¶, concUnit: ÂéüÊ∂≤ÊøÉÂ∫¶Âçò‰Ωç
// rateMin/rateMax: Êé®Â•®ÁØÑÂõ≤, rateDefault: „Éá„Éï„Ç©„É´„Éà
// diluted: Â∏åÈáàÂæå„ÅÆÊøÉÂ∫¶ÊÉÖÂ†±Ôºà„ÅÇ„Çå„Å∞Ôºâ
var CRI_MASTER = {
  dog: [
    { key:'fentanyl', name:'„Éï„Çß„É≥„Çø„Éã„É´', conc:50, concUnit:'Œºg/mL', diluted:{ conc:10, concUnit:'Œºg/mL', note:'5ÂÄçÂ∏åÈáà (ÁîüÈ£ü4mL+ÂéüÊ∂≤1mL)' }, calcType:'simple', rateUnit:'Œºg/kg/hr', rateMin:1, rateMax:5, rateDefault:2 },
    { key:'ketamine', name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:10, rateDefault:2 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
    { key:'dobutamine', name:'„Éâ„Éñ„Çø„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:5, rateMax:15, rateDefault:10 },
    { key:'propofol', name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´ÔºàÁô∫‰ΩúÈáçÁ©çÔºâ', conc:10, concUnit:'mg/mL', calcType:'simple', rateUnit:'mg/kg/min', rateMin:0.05, rateMax:0.2, rateDefault:0.1 },
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
    { key:'morphine', name:'„É¢„É´„Éí„Éç', conc:10, concUnit:'mg/mL', calcType:'simple', rateUnit:'mg/kg/hr', rateMin:0.1, rateMax:0.3, rateDefault:0.1 },
  ],
  cat: [
    { key:'fentanyl', name:'„Éï„Çß„É≥„Çø„Éã„É´', conc:50, concUnit:'Œºg/mL', diluted:{ conc:10, concUnit:'Œºg/mL', note:'5ÂÄçÂ∏åÈáà (ÁîüÈ£ü4mL+ÂéüÊ∂≤1mL)' }, calcType:'simple', rateUnit:'Œºg/kg/hr', rateMin:1, rateMax:4, rateDefault:2 },
    { key:'ketamine', name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:10, rateDefault:2 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
    { key:'dobutamine', name:'„Éâ„Éñ„Çø„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:5, rateMax:15, rateDefault:10 },
    { key:'propofol', name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´ÔºàÁô∫‰ΩúÈáçÁ©çÔºâ', conc:10, concUnit:'mg/mL', calcType:'simple', rateUnit:'mg/kg/min', rateMin:0.05, rateMax:0.2, rateDefault:0.1 },
    { key:'morphine', name:'„É¢„É´„Éí„Éç', conc:10, concUnit:'mg/mL', calcType:'simple', rateUnit:'mg/kg/hr', rateMin:0.05, rateMax:0.1, rateDefault:0.05 },
  ],
  rabbit: [
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
    { key:'metoclopramide', name:'„É°„Éà„ÇØ„É≠„Éó„É©„Éü„Éâ', conc:5, concUnit:'mg/mL', calcType:'infusion', rateUnit:'mg/kg/day', rateMin:1, rateMax:2, rateDefault:1 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
  ],
  ferret: [
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
    { key:'metoclopramide', name:'„É°„Éà„ÇØ„É≠„Éó„É©„Éü„Éâ', conc:5, concUnit:'mg/mL', calcType:'infusion', rateUnit:'mg/kg/day', rateMin:1, rateMax:2, rateDefault:1 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
  ],
  guinea_pig: [
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
    { key:'metoclopramide', name:'„É°„Éà„ÇØ„É≠„Éó„É©„Éü„Éâ', conc:5, concUnit:'mg/mL', calcType:'infusion', rateUnit:'mg/kg/day', rateMin:1, rateMax:2, rateDefault:1 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
  ],
  hamster: [
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
    { key:'metoclopramide', name:'„É°„Éà„ÇØ„É≠„Éó„É©„Éü„Éâ', conc:5, concUnit:'mg/mL', calcType:'infusion', rateUnit:'mg/kg/day', rateMin:1, rateMax:2, rateDefault:1 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
  ],
  bird: [
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
  ],
  reptile: [
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
  ],
  other: [
    { key:'dopamine', name:'„Éâ„Éë„Éü„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:2, rateMax:8, rateDefault:5 },
    { key:'lidocaine', name:'„É™„Éâ„Ç´„Ç§„É≥', conc:20, concUnit:'mg/mL', calcType:'infusion', rateUnit:'Œºg/kg/min', rateMin:50, rateMax:100, rateDefault:50 },
  ],
};

const DRUG_MASTER = {
  dog: { emergency: DRUG_MASTER_DEFAULT.emergency },
  cat: {
    emergency: [
      { name:'„Ç¢„Éà„É≠„Éî„É≥', conc:0.5, unit:'mg/mL', dosePerKg:0.02, doseUnit:'mg/kg' },
      { name:'„Ç®„Éï„Çß„Éâ„É™„É≥', conc:4, unit:'mg/mL', dosePerKg:0.05, doseUnit:'mg/kg' },
      { name:'„Ç®„Éî„Éç„Éï„É™„É≥', conc:1, unit:'mg/mL', dosePerKg:0.01, doseUnit:'mg/kg' },
      { name:'„Éä„É≠„Ç≠„ÇΩ„É≥', conc:0.4, unit:'mg/mL', dosePerKg:0.04, doseUnit:'mg/kg' },
      { name:'„Éâ„Ç≠„Çµ„Éó„É©„É†', conc:20, unit:'mg/mL', dosePerKg:1, doseUnit:'mg/kg' },
      { name:'„Éï„É´„Éû„Çº„Éã„É´', conc:0.1, unit:'mg/mL', dosePerKg:0.01, doseUnit:'mg/kg' },
    ],
  },
  rabbit: { emergency: DRUG_MASTER_DEFAULT.emergency },
  ferret: { emergency: DRUG_MASTER_DEFAULT.emergency },
  guinea_pig: { emergency: DRUG_MASTER_DEFAULT.emergency },
  hamster: { emergency: DRUG_MASTER_DEFAULT.emergency },
  bird: { emergency: DRUG_MASTER_DEFAULT.emergency },
  reptile: { emergency: DRUG_MASTER_DEFAULT.emergency },
  other: { emergency: DRUG_MASTER_DEFAULT.emergency },
};

// ===================================================================
//  PREMED / ANESTHESIA DRUG MASTER (per species)
// ===================================================================
let PREMED_MASTER = {
  dog: {
    premed: [
      { name:'„É°„Éá„Éà„Éü„Ç∏„É≥', conc:1, concUnit:'mg/mL', doseMin:0.005, doseMax:0.02, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.4, doseUnit:'mg/kg', route:'im' },
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.5, doseUnit:'mg/kg', route:'iv/im' },
      { name:'„Éû„É≠„Éî„Çø„É≥„Éà', conc:10, concUnit:'mg/mL', doseMin:1.0, doseMax:1.0, doseUnit:'mg/kg', route:'sc' },
      { name:'„Ç¢„Éà„É≠„Éî„É≥', conc:0.5, concUnit:'mg/mL', doseMin:0.02, doseMax:0.04, doseUnit:'mg/kg', route:'im/sc' },
      { name:'„Çª„Éï„Ç°„Çæ„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.2, doseUnit:'mg/kg', route:'sc' },
    ],
    induction: [
      { name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´', conc:10, concUnit:'mg/mL', doseMin:2, doseMax:6, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:1, doseMax:3, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„ÉÅ„Ç™„Éö„É≥„Çø„Éº„É´', conc:25, concUnit:'mg/mL', doseMin:10, doseMax:15, doseUnit:'mg/kg', route:'iv' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.0, doseMax:2.5, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:2.0, doseMax:4.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éï„Çß„É≥„Çø„Éã„É´', conc:0.05, concUnit:'mg/mL', doseMin:0.002, doseMax:0.005, doseUnit:'mg/kg', route:'iv' },
      { name:'„É¨„Éü„Éï„Çß„É≥„Çø„Éã„É´', conc:0.02, concUnit:'mg/mL', doseMin:0.005, doseMax:0.02, doseUnit:'mg/kg', route:'iv(CRI)' },
      { name:'„É¢„É´„Éí„Éç', conc:10, concUnit:'mg/mL', doseMin:0.2, doseMax:0.5, doseUnit:'mg/kg', route:'im' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:2, doseMax:5, doseUnit:'mg/kg', route:'iv/im' },
    ],
    antibiotic: [
      { name:'„Çª„Éï„Ç°„Çæ„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„É≥„Éî„Ç∑„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'sc/iv' },
      { name:'„É°„Éà„É≠„Éã„ÉÄ„Çæ„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:10, doseMax:15, doseUnit:'mg/kg', route:'iv' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:5, doseMax:10, doseUnit:'mL/kg/hr', route:'iv' },
      { name:'ÁîüÁêÜÈ£üÂ°©Ê∞¥', conc:null, concUnit:null, doseMin:5, doseMax:10, doseUnit:'mL/kg/hr', route:'iv' },
      { name:'ÈÖ¢ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:5, doseMax:10, doseUnit:'mL/kg/hr', route:'iv' },
      { name:'„Éò„Çπ„Éë„É≥„ÉÄ„Éº', conc:null, concUnit:null, doseMin:5, doseMax:20, doseUnit:'mL/kg', route:'iv' },
    ],
  },
  cat: {
    premed: [
      { name:'„É°„Éá„Éà„Éü„Ç∏„É≥', conc:1, concUnit:'mg/mL', doseMin:0.01, doseMax:0.04, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.4, doseUnit:'mg/kg', route:'im' },
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.3, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.01, doseMax:0.02, doseUnit:'mg/kg', route:'im' },
      { name:'„Ç¢„Éà„É≠„Éî„É≥', conc:0.5, concUnit:'mg/mL', doseMin:0.02, doseMax:0.04, doseUnit:'mg/kg', route:'im/sc' },
      { name:'„Çª„Éï„Ç°„Çæ„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.1, doseMax:0.2, doseUnit:'mg/kg', route:'sc' },
    ],
    induction: [
      { name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´', conc:10, concUnit:'mg/mL', doseMin:2, doseMax:6, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:2, doseMax:5, doseUnit:'mg/kg', route:'iv/im' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'im' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.0, doseMax:2.5, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:2.5, doseMax:4.5, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éï„Çß„É≥„Çø„Éã„É´', conc:0.05, concUnit:'mg/mL', doseMin:0.001, doseMax:0.003, doseUnit:'mg/kg', route:'iv' },
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.01, doseMax:0.02, doseUnit:'mg/kg', route:'im/iv' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:2, doseMax:5, doseUnit:'mg/kg', route:'im' },
    ],
    antibiotic: [
      { name:'„Çª„Éï„Ç°„Çæ„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„É≥„Éî„Ç∑„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:5, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„Éà„É≠„Éã„ÉÄ„Çæ„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:10, doseMax:15, doseUnit:'mg/kg', route:'iv' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:3, doseMax:5, doseUnit:'mL/kg/hr', route:'iv' },
      { name:'ÁîüÁêÜÈ£üÂ°©Ê∞¥', conc:null, concUnit:null, doseMin:3, doseMax:5, doseUnit:'mL/kg/hr', route:'iv' },
      { name:'ÈÖ¢ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:3, doseMax:5, doseUnit:'mL/kg/hr', route:'iv' },
    ],
  },
  rabbit: {
    premed: [
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:0.1, doseMax:0.5, doseUnit:'mg/kg', route:'im/sc' },
      { name:'„É°„Éá„Éà„Éü„Ç∏„É≥', conc:1, concUnit:'mg/mL', doseMin:0.1, doseMax:0.25, doseUnit:'mg/kg', route:'im' },
      { name:'„Ç¢„Éà„É≠„Éî„É≥', conc:0.5, concUnit:'mg/mL', doseMin:0.05, doseMax:0.1, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.3, doseMax:0.5, doseUnit:'mg/kg', route:'sc' },
    ],
    induction: [
      { name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´', conc:10, concUnit:'mg/mL', doseMin:3, doseMax:10, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:3, doseMax:6, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:10, doseMax:35, doseUnit:'mg/kg', route:'im' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.5, doseMax:3.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:3.0, doseMax:5.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.01, doseMax:0.05, doseUnit:'mg/kg', route:'sc/iv' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.3, doseMax:0.5, doseUnit:'mg/kg', route:'sc' },
    ],
    antibiotic: [
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'sc' },
      { name:'„Çª„Éï„Ç°„Çæ„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:10, doseMax:10, doseUnit:'mL/kg/hr', route:'iv' },
      { name:'ÁîüÁêÜÈ£üÂ°©Ê∞¥', conc:null, concUnit:null, doseMin:10, doseMax:10, doseUnit:'mL/kg/hr', route:'iv' },
    ],
  },
  ferret: {
    premed: [
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:0.25, doseMax:0.5, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:0.1, doseMax:0.2, doseUnit:'mg/kg', route:'im' },
      { name:'„É°„Éá„Éà„Éü„Ç∏„É≥', conc:1, concUnit:'mg/mL', doseMin:0.08, doseMax:0.1, doseUnit:'mg/kg', route:'im' },
      { name:'„Ç¢„Éà„É≠„Éî„É≥', conc:0.5, concUnit:'mg/mL', doseMin:0.02, doseMax:0.04, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.2, doseUnit:'mg/kg', route:'sc' },
    ],
    induction: [
      { name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´', conc:10, concUnit:'mg/mL', doseMin:2, doseMax:8, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:2, doseMax:5, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'im' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.5, doseMax:3.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:3.0, doseMax:5.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.01, doseMax:0.03, doseUnit:'mg/kg', route:'sc' },
    ],
    antibiotic: [
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'sc' },
      { name:'„Çª„Éï„Ç°„Çæ„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:5, doseMax:10, doseUnit:'mL/kg/hr', route:'iv/sc' },
    ],
  },
  guinea_pig: {
    premed: [
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.4, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„Éá„Éà„Éü„Ç∏„É≥', conc:1, concUnit:'mg/mL', doseMin:0.05, doseMax:0.1, doseUnit:'mg/kg', route:'im' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.5, doseUnit:'mg/kg', route:'sc' },
    ],
    induction: [
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'iv/im' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:20, doseMax:40, doseUnit:'mg/kg', route:'im' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.5, doseMax:3.5, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:3.0, doseMax:5.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.05, doseMax:0.1, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.5, doseUnit:'mg/kg', route:'sc' },
    ],
    antibiotic: [
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'sc' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:10, doseMax:10, doseUnit:'mL/kg/hr', route:'iv/sc' },
    ],
  },
  hamster: {
    premed: [
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:1.0, doseMax:2.0, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:1.0, doseMax:2.0, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„Éá„Éà„Éü„Ç∏„É≥', conc:1, concUnit:'mg/mL', doseMin:0.1, doseMax:0.3, doseUnit:'mg/kg', route:'im' },
    ],
    induction: [
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'ip' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:50, doseMax:100, doseUnit:'mg/kg', route:'ip' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.5, doseMax:3.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.05, doseMax:0.1, doseUnit:'mg/kg', route:'sc' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.5, doseUnit:'mg/kg', route:'sc' },
    ],
    antibiotic: [
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'sc' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:10, doseMax:10, doseUnit:'mL/kg/hr', route:'sc' },
    ],
  },
  bird: {
    premed: [
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:0.5, doseMax:2.0, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:1.0, doseMax:2.0, doseUnit:'mg/kg', route:'im' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'im' },
    ],
    induction: [
      { name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´', conc:10, concUnit:'mg/mL', doseMin:3, doseMax:5, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:10, doseMax:20, doseUnit:'mg/kg', route:'iv/im' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:1.5, doseMax:3.5, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:3.0, doseMax:5.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éñ„Éó„É¨„Éé„É´„Éï„Ç£„É≥', conc:0.3, concUnit:'mg/mL', doseMin:0.01, doseMax:0.05, doseUnit:'mg/kg', route:'im' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'im' },
    ],
    antibiotic: [
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:10, doseMax:15, doseUnit:'mg/kg', route:'im' },
      { name:'„Ç¢„É≥„Éî„Ç∑„É™„É≥', conc:100, concUnit:'mg/mL', doseMin:100, doseMax:200, doseUnit:'mg/kg', route:'im' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:10, doseMax:10, doseUnit:'mL/kg/hr', route:'iv/io' },
    ],
  },
  reptile: {
    premed: [
      { name:'„Éü„ÉÄ„Çæ„É©„É†', conc:5, concUnit:'mg/mL', doseMin:1.0, doseMax:2.0, doseUnit:'mg/kg', route:'im' },
      { name:'„Éñ„Éà„É´„Éï„Ç°„Éé„Éº„É´', conc:5, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'im' },
      { name:'„É°„É≠„Ç≠„Ç∑„Ç´„É†', conc:5, concUnit:'mg/mL', doseMin:0.2, doseMax:0.5, doseUnit:'mg/kg', route:'im' },
    ],
    induction: [
      { name:'„Éó„É≠„Éù„Éï„Ç©„Éº„É´', conc:10, concUnit:'mg/mL', doseMin:5, doseMax:15, doseUnit:'mg/kg', route:'iv slow' },
      { name:'„Ç¢„É´„Éï„Ç°„Ç≠„Çµ„É≠„É≥', conc:10, concUnit:'mg/mL', doseMin:5, doseMax:15, doseUnit:'mg/kg', route:'iv/im' },
      { name:'„Ç±„Çø„Éü„É≥', conc:50, concUnit:'mg/mL', doseMin:20, doseMax:60, doseUnit:'mg/kg', route:'im' },
    ],
    maintenance: [
      { name:'„Ç§„ÇΩ„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:2.0, doseMax:4.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
      { name:'„Çª„Éú„Éï„É´„É©„É≥', conc:null, concUnit:null, doseMin:3.0, doseMax:6.0, doseUnit:'%', route:'Âê∏ÂÖ•' },
    ],
    analgesic: [
      { name:'„Éà„É©„Éû„Éâ„Éº„É´', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'po/im' },
    ],
    antibiotic: [
      { name:'„Ç®„É≥„É≠„Éï„É≠„Ç≠„Çµ„Ç∑„É≥', conc:50, concUnit:'mg/mL', doseMin:5, doseMax:10, doseUnit:'mg/kg', route:'im' },
      { name:'„Çª„Éï„Çø„Ç∏„Ç∏„É†', conc:100, concUnit:'mg/mL', doseMin:20, doseMax:40, doseUnit:'mg/kg', route:'im' },
      { name:'„Éà„É©„É≥„Çµ„Éü„É≥', conc:100, concUnit:'mg/mL', doseMin:10, doseMax:25, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¢„Éâ„Éä', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
      { name:'„Ç¨„Çπ„Çø„Éº', conc:10, concUnit:'mg/mL', doseMin:0.5, doseMax:1.0, doseUnit:'mg/kg', route:'iv' },
    ],
    fluid: [
      { name:'‰π≥ÈÖ∏„É™„É≥„Ç≤„É´', conc:null, concUnit:null, doseMin:5, doseMax:10, doseUnit:'mL/kg/day', route:'sc/ico' },
    ],
  },
  other: null, // uses dog defaults
};

const PREMED_CATEGORY_LABELS = {
  premed: { label:'ÂâçÊäïËñ¨', icon:'üíä' },
  induction: { label:'È∫ªÈÖîÂ∞éÂÖ•Ëñ¨', icon:'üîß' },
  maintenance: { label:'Á∂≠ÊåÅÈ∫ªÈÖî', icon:'üí®' },
  analgesic: { label:'ÈéÆÁóõ„Éª„Åù„ÅÆ‰ªñ', icon:'üíâ' },
  antibiotic: { label:'ÊäóÁîüÂâ§„Éª„Åù„ÅÆ‰ªñ', icon:'üõ°' },
  fluid: { label:'Ëº∏Ê∂≤', icon:'ü©∏' },
};

// ===================================================================
//  SEX TOGGLE
// ===================================================================
function setSex(sex) {
  state.selectedSex = sex;
  const classMap = { male:'active-male', castrated:'active-castrated', female:'active-female', spayed:'active-spayed', unknown:'active-unknown' };
  document.querySelectorAll('#sexToggle button').forEach(b => {
    b.classList.remove('active-male','active-female','active-castrated','active-spayed','active-unknown');
    if (b.dataset.sex === sex) b.classList.add(classMap[sex] || 'active-unknown');
  });
}

// ===================================================================
//  STARTUP
// ===================================================================
document.addEventListener('DOMContentLoaded', () => {
  try {
    document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
  } catch(e) { console.warn('init date error:', e); }
});

function startSession() {
  const name = document.getElementById('inputName').value.trim();
  const weight = parseFloat(document.getElementById('inputWeight').value);
  if (!name || !weight || weight <= 0) { alert('ÊÇ£ËÄÖÂêç„Å®‰ΩìÈáç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }

  const species = document.getElementById('inputSpecies').value;
  state.patient = {
    id: document.getElementById('inputId').value.trim() || '-',
    name, species, weight,
    age: document.getElementById('inputAge').value.trim() || '-',
    sex: state.selectedSex || '-',
    procedure: document.getElementById('inputProcedure').value.trim() || '-',
    notes: document.getElementById('inputNotes').value.trim(),
    surgeon: document.getElementById('inputSurgeon').value.trim(),
    anesthetist: document.getElementById('inputAnesthetist').value.trim(),
    date: document.getElementById('inputDate').value,
  };

  // Show drug prep screen
  document.getElementById('startupScreen').style.display = 'none';
  showDrugPrepScreen();
}

// ===================================================================
//  DRUG PREPARATION SCREEN
// ===================================================================
function showDrugPrepScreen() {
  const sp = state.patient.species;
  const w = state.patient.weight;
  const wDisp = w < 1 ? (w*1000).toFixed(0)+'g' : w.toFixed(1)+'kg';

  // Patient bar
  document.getElementById('prepPatientBar').innerHTML =
    `<span class="species-emoji">${SPECIES_EMOJI[sp]||'üêæ'}</span>` +
    `<span><strong>${state.patient.name}</strong> (${SPECIES_LABELS[sp]||sp})</span>` +
    `<span class="weight-badge">${wDisp}</span>` +
    (state.patient.procedure !== '-' ? `<span style="color:var(--text-secondary)">${state.patient.procedure}</span>` : '');

  buildPrepDrugList(sp, w);
  document.getElementById('drugPrepScreen').style.display = 'flex';
}

function buildPrepDrugList(species, weight) {
  const container = document.getElementById('prepDrugList');
  container.innerHTML = '';
  const master = PREMED_MASTER[species] || PREMED_MASTER.dog;

  let drugIdx = 0;
  for (const [catKey, catInfo] of Object.entries(PREMED_CATEGORY_LABELS)) {
    const drugs = master[catKey];
    if (!drugs || drugs.length === 0) continue;

    const section = document.createElement('div');
    section.className = 'prep-category';

    const title = document.createElement('div');
    title.className = 'prep-category-title';
    title.innerHTML = `<span class="arrow">‚ñº</span> ${catInfo.icon} ${catInfo.label}`;
    title.onclick = function() {
      this.classList.toggle('collapsed');
      this.nextElementSibling.classList.toggle('hidden');
    };
    section.appendChild(title);

    const list = document.createElement('div');
    list.className = 'prep-drug-list';

    drugs.forEach(drug => {
      const idx = drugIdx++;
      const row = document.createElement('div');
      row.className = 'prep-drug-row';
      row.id = 'prepRow_' + idx;

      const isInhale = drug.conc === null;
      const defaultDose = drug.doseMin;
      const doseMg = isInhale ? null : (defaultDose * weight);
      const volMl = isInhale ? null : (doseMg / drug.conc);

      let calcHtml = '';
      if (isInhale) {
        calcHtml = `<span class="prep-drug-calc">${drug.doseMin}-${drug.doseMax}${drug.doseUnit}</span>`;
      } else {
        const volDisp = volMl < 0.01 ? volMl.toFixed(4) : volMl < 0.1 ? volMl.toFixed(3) : volMl.toFixed(2);
        calcHtml = `<span class="prep-drug-calc" id="prepCalc_${idx}"><strong>${volDisp} mL</strong><br><span class="calc-detail">${doseMg < 0.01 ? doseMg.toFixed(4) : doseMg.toFixed(2)}${drug.doseUnit.replace('/kg','')}</span></span>`;
      }

      row.innerHTML =
        `<input type="checkbox" id="prepChk_${idx}" onchange="togglePrepRow(${idx})">` +
        `<span class="prep-drug-name">${drug.name}</span>` +
        `<span class="prep-drug-dose-range">${drug.doseMin}~${drug.doseMax}<br>${drug.doseUnit}</span>` +
        (isInhale ? '' : `<input type="number" class="prep-drug-input" id="prepDose_${idx}" value="${defaultDose}" step="any" min="0" data-idx="${idx}" data-conc="${drug.conc}" data-unit="${drug.doseUnit}" onchange="updatePrepCalc(${idx})">`) +
        (isInhale ? '' : `<span class="prep-drug-unit">${drug.doseUnit}</span>`) +
        calcHtml +
        `<span class="prep-drug-route">${drug.route}</span>`;

      list.appendChild(row);
    });

    section.appendChild(list);
    container.appendChild(section);
  }
}

function togglePrepRow(idx) {
  const row = document.getElementById('prepRow_' + idx);
  const chk = document.getElementById('prepChk_' + idx);
  if (row) row.classList.toggle('checked', chk && chk.checked);
}

function updatePrepCalc(idx) {
  const input = document.getElementById('prepDose_' + idx);
  const calcEl = document.getElementById('prepCalc_' + idx);
  if (!input || !calcEl) return;

  const dosePerKg = parseFloat(input.value) || 0;
  const conc = parseFloat(input.dataset.conc);
  const unit = input.dataset.unit;
  const w = state.patient.weight;
  const doseMg = dosePerKg * w;
  const volMl = doseMg / conc;

  const volDisp = volMl < 0.01 ? volMl.toFixed(4) : volMl < 0.1 ? volMl.toFixed(3) : volMl.toFixed(2);
  calcHtml = `<strong>${volDisp} mL</strong><br><span class="calc-detail">${doseMg < 0.01 ? doseMg.toFixed(4) : doseMg.toFixed(2)}${unit.replace('/kg','')}</span>`;
  calcEl.innerHTML = calcHtml;
}

function completeDrugPrep() {
  // Log selected drugs
  const checks = document.querySelectorAll('[id^="prepChk_"]');
  const selected = [];
  checks.forEach(chk => {
    if (chk.checked) {
      const row = chk.closest('.prep-drug-row');
      var nameEl = row.querySelector('.prep-drug-name');
      var calcEl = row.querySelector('.prep-drug-calc');
      const name = nameEl ? nameEl.textContent : '';
      const calc = calcEl ? calcEl.textContent : '';
      selected.push(`${name} ${calc.replace(/\n/g,' ').trim()}`);
    }
  });

  document.getElementById('drugPrepScreen').style.display = 'none';
  startMonitoring();

  if (selected.length > 0) {
    addLog(`üíâ Ëñ¨Ââ§Ê∫ñÂÇô: ${selected.join(', ')}`);
  }
}

function skipDrugPrep() {
  document.getElementById('drugPrepScreen').style.display = 'none';
  startMonitoring();
}

function startMonitoring() {
  state.sessionStart = new Date();

  document.getElementById('dispId').textContent = state.patient.id;
  document.getElementById('dispName').textContent = state.patient.name;
  const sp = state.patient.species;
  document.getElementById('dispSpecies').textContent = (SPECIES_LABELS[sp]||sp) + ' ' + (SPECIES_EMOJI[sp]||'');
  const weight = state.patient.weight;
  document.getElementById('dispWeight').textContent = weight < 1 ? (weight*1000).toFixed(0)+'g' : weight.toFixed(1)+'kg';
  const sexMap = { male:'‚ôÇ', female:'‚ôÄ', unknown:'?' };
  document.getElementById('dispSex').textContent = sexMap[state.patient.sex] || '-';
  const procBadge = document.getElementById('dispProcedure');
  procBadge.textContent = state.patient.procedure;
  procBadge.title = state.patient.procedure;
  if (state.patient.notes) {
    const notesBadge = document.getElementById('dispNotes');
    notesBadge.style.display = 'block';
    notesBadge.title = state.patient.notes;
  }

  buildEmergencyDrugs(); buildCriDrugSelect(); resetTimer();
  state.elapsedInterval = setInterval(updateElapsed, 1000);
  initChart();
  document.getElementById('mainApp').style.display = 'block';

  let logMsg = '„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã';
  if (state.patient.surgeon) logMsg += ` | Âü∑ÂàÄÂåª: ${state.patient.surgeon}`;
  if (state.patient.anesthetist) logMsg += ` | È∫ªÈÖî: ${state.patient.anesthetist}`;
  addLog(logMsg);
  if (state.patient.notes) addLog(`‚ö† ÂÇôËÄÉ: ${state.patient.notes}`);
}

function showNotesPopup() {
  if (!state.patient.notes) return;
  const c = document.getElementById('alertContainer');
  const o = document.createElement('div'); o.className='notes-overlay';
  o.innerHTML = `<div class="notes-popup"><h3>‚ö† ÂÇôËÄÉ„ÉªÊ≥®ÊÑè‰∫ãÈ†Ö</h3><p>${state.patient.notes}</p><button onclick="this.closest('.notes-overlay').remove()">Èñâ„Åò„Çã</button></div>`;
  c.appendChild(o);
}

// ===================================================================
//  MANUAL VITAL INPUT
// ===================================================================
function applyManualVitals() {
  const get = id => { const v = document.getElementById(id).value; return v !== '' ? parseFloat(v) : null; };
  const hr = get('mvHR'), spo2 = get('mvSpO2'), rr = get('mvRR'), etco2 = get('mvEtCO2');
  const sys = get('mvSys'), dia = get('mvDia'), temp = get('mvTemp'), iso = get('mvIso');

  if ([hr,spo2,rr,etco2,sys,dia,temp,iso].every(v => v === null)) { return; }

  // Carry forward from current display for unfilled fields
  const cur = id => parseInt(document.getElementById(id).textContent) || 0;
  const curF = id => parseFloat(document.getElementById(id).textContent) || 0;
  const fSys = sys ?? cur('valSys'), fDia = dia ?? cur('valDia');
  const mean = (fSys && fDia) ? Math.round(fDia + (fSys - fDia) / 3) : cur('valMean');

  const d = {
    hr: hr ?? cur('valHR'),
    spo2: spo2 ?? cur('valSpO2'),
    rr: rr ?? cur('valRR'),
    etco2: etco2 ?? cur('valEtCO2'),
    sys: fSys, dia: fDia, mean,
    temp: temp ?? curF('valTemp'),
    iso: iso ?? curF('valIso'),
  };

  applyVitalData(d, null, true);
  // Clear inputs
  ['mvHR','mvSpO2','mvRR','mvEtCO2','mvSys','mvDia','mvTemp','mvIso'].forEach(id => document.getElementById(id).value = '');
  resetTimer();
}

// ===================================================================
//  ELAPSED / TIMER / ANNOUNCE / SPEAK
// ===================================================================
function updateElapsed() {
  if (!state.sessionStart) return;
  const d = Math.floor((Date.now()-state.sessionStart)/1000);
  document.getElementById('dispElapsed').textContent = `ÁµåÈÅé ${String(Math.floor(d/3600)).padStart(2,'0')}:${String(Math.floor((d%3600)/60)).padStart(2,'0')}:${String(d%60).padStart(2,'0')}`;
}
function resetTimer() {
  state.timerRemaining=300; if(state.timerInterval) clearInterval(state.timerInterval);
  state.timerInterval=setInterval(tickTimer,1000); updateTimerDisplay();
}
function tickTimer() {
  state.timerRemaining--; if(state.timerRemaining<=0){state.timerRemaining=0;clearInterval(state.timerInterval);speak('„É¢„Éã„Çø„ÉºÊíÆÂΩ±„ÅÆÊôÇÈñì„Åß„Åô');}
  updateTimerDisplay();
}
function updateTimerDisplay() {
  const t=state.timerRemaining, pct=(t/300)*100, bar=document.getElementById('timerBar');
  bar.style.width=pct+'%'; bar.classList.remove('warning','critical','danger');
  if(pct<=10)bar.classList.add('danger');else if(pct<=30)bar.classList.add('critical');else if(pct<=50)bar.classList.add('warning');
  document.getElementById('timerText').textContent=`${Math.floor(t/60)}:${String(t%60).padStart(2,'0')}`;
  const tt=document.getElementById('timerText');
  if(pct<=10)tt.style.color='var(--accent-red)';else if(pct<=30)tt.style.color='var(--accent-orange)';else if(pct<=50)tt.style.color='var(--accent-yellow)';else tt.style.color='var(--text-primary)';
}
function startAnnounce(type) {
  if(state.announceType===type){clearInterval(state.announceInterval);state.announceType=null;state.announceStart=null;document.getElementById('btnInduction').classList.remove('active');document.getElementById('btnIncision').classList.remove('active');document.getElementById('announceStatus').textContent='-';return;}
  state.announceType=type;state.announceStart=Date.now();
  document.getElementById('btnInduction').classList.toggle('active',type==='induction');
  document.getElementById('btnIncision').classList.toggle('active',type==='incision');
  if(state.announceInterval)clearInterval(state.announceInterval);state.announceInterval=setInterval(checkAnnounce,1000);
  const l=type==='induction'?'Â∞éÂÖ•':'ÂàáÁöÆ'; addLog(`${l} „Çø„Ç§„Éû„ÉºÈñãÂßã`); updateAnnounceStatus();
}
function checkAnnounce() {
  if(!state.announceStart)return; updateAnnounceStatus();
  const e=Math.floor((Date.now()-state.announceStart)/1000);
  if(e>0&&e%1800===0){const m=e/60,l=state.announceType==='induction'?'Â∞éÂÖ•':'ÂàáÁöÆ';speak(`${l}„Åã„Çâ${m}ÂàÜÁµåÈÅé`);addLog(`üîä ${l}„Åã„Çâ${m}ÂàÜÁµåÈÅé`);}
}
function updateAnnounceStatus() {
  if(!state.announceStart)return;const e=Math.floor((Date.now()-state.announceStart)/1000);
  const l=state.announceType==='induction'?'Â∞éÂÖ•':'ÂàáÁöÆ';
  document.getElementById('announceStatus').textContent=`${l}„Åã„Çâ ${Math.floor(e/60)}:${String(e%60).padStart(2,'0')} ÁµåÈÅé`;
}
function speak(text){if('speechSynthesis' in window){const u=new SpeechSynthesisUtterance(text);u.lang='ja-JP';u.rate=1.0;speechSynthesis.speak(u);}}

// ===================================================================
//  CRI (Excel worksheetÊ∫ñÊã†)
// ===================================================================
function buildCriDrugSelect() {
  var sel = document.getElementById('criDrug');
  if (!sel) return;
  sel.innerHTML = '';
  var sp = state.patient.species || 'dog';
  var drugs = CRI_MASTER[sp] || CRI_MASTER.dog;
  drugs.forEach(function(d, i) {
    var opt = document.createElement('option');
    opt.value = i;
    var label = d.name + ' (' + d.conc + d.concUnit;
    if (d.diluted) label += ' ‚Üí Â∏åÈáà' + d.diluted.conc + d.diluted.concUnit;
    label += ')';
    opt.textContent = label;
    sel.appendChild(opt);
  });
  updateCRI();
}

function updateCRI() {
  var sel = document.getElementById('criDrug');
  var panel = document.getElementById('criCalcPanel');
  if (!sel || !panel) return;
  var sp = state.patient.species || 'dog';
  var drugs = CRI_MASTER[sp] || CRI_MASTER.dog;
  var idx = parseInt(sel.value) || 0;
  if (idx < 0 || idx >= drugs.length) idx = 0;
  var d = drugs[idx];
  var w = state.patient.weight || 1;

  var html = '';

  if (d.calcType === 'simple') {
    // === Simple CRI („Éï„Çß„É≥„Çø„Éã„É´„ÄÅ„Éó„É≠„Éù„Éï„Ç©„Éº„É´„ÄÅ„É¢„É´„Éí„ÉçÁ≠â) ===
    var useConc = d.diluted ? d.diluted.conc : d.conc;
    var useConcUnit = d.diluted ? d.diluted.concUnit : d.concUnit;

    // Â∏åÈáàÊÉÖÂ†±
    if (d.diluted) {
      html += '<div style="background:rgba(6,182,212,0.1);border:1px solid rgba(6,182,212,0.3);border-radius:6px;padding:6px 8px;margin-bottom:6px;font-size:11px;color:var(--accent-cyan);">';
      html += 'üíß ' + d.diluted.note + ' ‚Üí <strong>' + d.diluted.conc + ' ' + d.diluted.concUnit + '</strong>';
      html += '</div>';
    }

    html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">Êé®Â•®: ' + d.rateMin + '„Äú' + d.rateMax + ' ' + d.rateUnit + '</div>';

    // Êäï‰∏éÈÄüÂ∫¶„ÉÜ„Éº„Éñ„É´
    html += '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
    html += '<thead><tr><th style="text-align:left;padding:3px 6px;border-bottom:1px solid var(--border);color:var(--text-secondary);">' + d.rateUnit + '</th>';
    html += '<th style="text-align:right;padding:3px 6px;border-bottom:1px solid var(--border);color:var(--text-secondary);">mL/hr</th></tr></thead><tbody>';

    var steps = generateRateSteps(d);
    steps.forEach(function(rate) {
      var mlhr = calcSimpleMlHr(rate, d.rateUnit, useConc, useConcUnit, w);
      var isDefault = (rate === d.rateDefault);
      var style = isDefault ? 'background:rgba(59,130,246,0.12);font-weight:700;' : '';
      html += '<tr style="' + style + '"><td style="padding:3px 6px;border-bottom:1px solid rgba(42,53,80,0.3);">' + rate + '</td>';
      html += '<td style="padding:3px 6px;border-bottom:1px solid rgba(42,53,80,0.3);text-align:right;font-family:monospace;"><strong>' + mlhr.toFixed(3) + '</strong></td></tr>';
    });
    html += '</tbody></table>';

  } else {
    // === Infusion bag CRI („Éâ„Éë„Éü„É≥„ÄÅ„Éâ„Éñ„Çø„Éü„É≥„ÄÅ„Ç±„Çø„Éü„É≥„ÄÅ„É™„Éâ„Ç´„Ç§„É≥„ÄÅ„É°„Éà„ÇØ„É≠„Éó„É©„Éü„Éâ) ===
    // Excel„ÉØ„Éº„ÇØ„Ç∑„Éº„ÉàÊñπÂºè: Ëº∏Ê∂≤„Éë„ÉÉ„ÇØ„Å´Ëñ¨Ââ§„ÇíÊ∑ªÂä†
    var fluidVol = 50;  // „Éá„Éï„Ç©„É´„ÉàËº∏Ê∂≤Èáè(mL)
    if (w >= 10) fluidVol = 250;
    else if (w >= 5) fluidVol = 100;

    var fluidRate = 10; // „Éá„Éï„Ç©„É´„ÉàÁÇπÊª¥ÊµÅÈáè(mL/hr)
    if (w >= 10) fluidRate = 20;
    else if (w >= 3) fluidRate = 8;
    else if (w >= 1) fluidRate = 5;
    else fluidRate = 2;

    html += '<div style="font-size:11px;color:var(--text-secondary);margin-bottom:4px;">Êé®Â•®: ' + d.rateMin + '„Äú' + d.rateMax + ' ' + d.rateUnit + '</div>';

    // ÂÖ•Âäõ„Éï„Ç©„Éº„É†
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:6px;">';
    html += '<div style="font-size:10px;"><label style="color:var(--text-muted);">Ëº∏Ê∂≤Èáè(mL)</label><input type="number" id="criFluidVol" value="' + fluidVol + '" min="1" step="1" style="width:100%;padding:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;" onchange="recalcInfusionCRI()"></div>';
    html += '<div style="font-size:10px;"><label style="color:var(--text-muted);">ÁÇπÊª¥ÊµÅÈáè(mL/hr)</label><input type="number" id="criFluidRate" value="' + fluidRate + '" min="0.1" step="0.1" style="width:100%;padding:4px;background:var(--bg-card);border:1px solid var(--border);border-radius:4px;color:var(--text-primary);font-size:12px;" onchange="recalcInfusionCRI()"></div>';
    html += '</div>';

    // ÈÄüÂ∫¶„ÉÜ„Éº„Éñ„É´
    html += '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
    html += '<thead><tr><th style="text-align:left;padding:3px 6px;border-bottom:1px solid var(--border);color:var(--text-secondary);">' + d.rateUnit + '</th>';
    html += '<th style="text-align:right;padding:3px 6px;border-bottom:1px solid var(--border);color:var(--text-secondary);">Ê∑ªÂä†Èáè(mL)</th></tr></thead><tbody>';

    var steps2 = generateRateSteps(d);
    steps2.forEach(function(rate) {
      var addMl = calcInfusionAddMl(rate, d.rateUnit, d.conc, d.concUnit, w, fluidVol, fluidRate);
      var isDefault = (rate === d.rateDefault);
      var style = isDefault ? 'background:rgba(59,130,246,0.12);font-weight:700;' : '';
      html += '<tr style="' + style + '" class="cri-infusion-row" data-rate="' + rate + '"><td style="padding:3px 6px;border-bottom:1px solid rgba(42,53,80,0.3);">' + rate + '</td>';
      html += '<td style="padding:3px 6px;border-bottom:1px solid rgba(42,53,80,0.3);text-align:right;font-family:monospace;" class="cri-add-ml"><strong>' + addMl.toFixed(3) + '</strong></td></tr>';
    });
    html += '</tbody></table>';

    html += '<div style="margin-top:6px;padding:6px 8px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:6px;font-size:10px;color:var(--accent-yellow);">';
    html += 'üìã ÈÅ∏„Çì„Å†ÈÄüÂ∫¶„ÅÆÊ∑ªÂä†Èáè„ÇíËº∏Ê∂≤„Éë„ÉÉ„ÇØ„Å´Ê∑∑Ê≥® ‚Üí Ë®≠ÂÆö„Åó„ÅüÊµÅÈáè(mL/hr)„ÅßÊäï‰∏é';
    html += '</div>';
  }

  panel.innerHTML = html;
}

function generateRateSteps(d) {
  var steps = [];
  var range = d.rateMax - d.rateMin;
  var step = 1;
  if (range <= 1) step = 0.05;
  else if (range <= 5) step = 0.5;
  else if (range <= 20) step = 1;
  else if (range <= 50) step = 5;
  else step = 10;

  for (var r = d.rateMin; r <= d.rateMax + step * 0.01; r += step) {
    var rounded = Math.round(r * 1000) / 1000;
    steps.push(rounded);
  }
  // rateDefault„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Å™„Åë„Çå„Å∞ËøΩÂä†„Åó„Å¶„ÇΩ„Éº„Éà
  var hasDefault = false;
  for (var s = 0; s < steps.length; s++) {
    if (Math.abs(steps[s] - d.rateDefault) < 0.001) { hasDefault = true; break; }
  }
  if (!hasDefault) {
    steps.push(d.rateDefault);
    steps.sort(function(a, b) { return a - b; });
  }
  return steps;
}

// Simple CRI: Êäï‰∏éÈÄüÂ∫¶ ‚Üí mL/hr
function calcSimpleMlHr(rate, rateUnit, conc, concUnit, w) {
  // Âçò‰ΩçÁµ±‰∏Ä: rate„Çí"Èáè/ÊôÇÈñì"„Å´Â§âÊèõ„Åó„ÄÅconc(Èáè/mL)„ÅßÂâ≤„Çã
  // rateUnit‰æã: Œºg/kg/hr, mg/kg/min, mg/kg/hr
  var amountPerHr = 0; // ÂéüËñ¨„ÅÆconcUnitÊèõÁÆó„Åß„ÅÆÈáè/hr/kg

  if (rateUnit.indexOf('/min') >= 0) {
    amountPerHr = rate * 60; // ‚Üí /hr
  } else if (rateUnit.indexOf('/hr') >= 0 || rateUnit.indexOf('/hour') >= 0) {
    amountPerHr = rate;
  } else if (rateUnit.indexOf('/day') >= 0) {
    amountPerHr = rate / 24;
  } else {
    amountPerHr = rate; // fallback
  }

  // Œºg/mgÂ§âÊèõ
  var rateIsMicro = rateUnit.indexOf('Œºg') >= 0;
  var concIsMicro = concUnit.indexOf('Œºg') >= 0;
  if (rateIsMicro && !concIsMicro) amountPerHr = amountPerHr / 1000; // Œºg‚Üímg
  if (!rateIsMicro && concIsMicro) amountPerHr = amountPerHr * 1000; // mg‚ÜíŒºg

  return (amountPerHr * w) / conc; // mL/hr
}

// Infusion CRI: ExcelÊñπÂºè ‚Äî Ëº∏Ê∂≤„Éë„ÉÉ„ÇØ„Å´Ê∑ªÂä†„Åô„ÇãmLÊï∞„ÇíÁÆóÂá∫
// Ë®àÁÆó: addMl = (rate √ó w √ó fluidVol) / (fluidRate √ó conc √ó unitFactor)
function calcInfusionAddMl(rate, rateUnit, conc, concUnit, w, fluidVol, fluidRate) {
  // rate(Êäï‰∏éÈÄüÂ∫¶, e.g. 5 Œºg/kg/min) „Åã„Çâ
  // 1ÊôÇÈñì„ÅÇ„Åü„Çä„ÅÆÂøÖË¶ÅÈáè(mg/hr)„ÇíË®àÁÆó
  var amountPerHr = 0;

  if (rateUnit.indexOf('/min') >= 0) {
    amountPerHr = rate * 60;
  } else if (rateUnit.indexOf('/hr') >= 0 || rateUnit.indexOf('/hour') >= 0) {
    amountPerHr = rate;
  } else if (rateUnit.indexOf('/day') >= 0) {
    amountPerHr = rate / 24;
  } else {
    amountPerHr = rate;
  }

  // Œºg‚ÜímgÂ§âÊèõ
  var rateIsMicro = rateUnit.indexOf('Œºg') >= 0;
  var concIsMg = concUnit.indexOf('mg') >= 0;
  if (rateIsMicro && concIsMg) amountPerHr = amountPerHr / 1000;

  // 1ÊôÇÈñì„ÅÆÂøÖË¶ÅÈáè(mg) = amountPerHr * w
  var mgPerHr = amountPerHr * w;

  // Ëº∏Ê∂≤„Éë„ÉÉ„ÇØ‰∏≠„ÅÆÂøÖË¶ÅÊøÉÂ∫¶(mg/mL) = mgPerHr / fluidRate
  var needConcMgMl = mgPerHr / (fluidRate || 1);

  // Ê∑ªÂä†Èáè(mL) = needConcMgMl * fluidVol / conc
  var addMl = needConcMgMl * fluidVol / conc;
  return addMl;
}

function recalcInfusionCRI() {
  var fluidVolEl = document.getElementById('criFluidVol');
  var fluidRateEl = document.getElementById('criFluidRate');
  if (!fluidVolEl || !fluidRateEl) return;
  var fluidVol = parseFloat(fluidVolEl.value) || 50;
  var fluidRate = parseFloat(fluidRateEl.value) || 10;

  var sp = state.patient.species || 'dog';
  var drugs = CRI_MASTER[sp] || CRI_MASTER.dog;
  var sel = document.getElementById('criDrug');
  var idx = parseInt(sel.value) || 0;
  var d = drugs[idx];
  var w = state.patient.weight || 1;

  var rows = document.querySelectorAll('.cri-infusion-row');
  rows.forEach(function(row) {
    var rate = parseFloat(row.dataset.rate);
    var addMl = calcInfusionAddMl(rate, d.rateUnit, d.conc, d.concUnit, w, fluidVol, fluidRate);
    var td = row.querySelector('.cri-add-ml');
    if (td) td.innerHTML = '<strong>' + addMl.toFixed(3) + '</strong>';
  });
}

// ===================================================================
//  EMERGENCY DRUGS
// ===================================================================
function buildEmergencyDrugs(){
  const g=document.getElementById('emergGrid');g.innerHTML='';
  const sp=state.patient.species; const drugs=(DRUG_MASTER[sp]||DRUG_MASTER.dog).emergency;
  const w=state.patient.weight;
  drugs.forEach(drug=>{
    const vol=(drug.dosePerKg*w)/drug.conc; const btn=document.createElement('button');
    btn.className='btn-emerg';
    btn.innerHTML=`<div class="drug-name">${drug.name}</div><div class="drug-dose">${vol<0.01?vol.toFixed(3):vol.toFixed(2)} mL</div><div class="drug-detail">${drug.dosePerKg}${drug.doseUnit}√ó${w<1?(w*1000).toFixed(0)+'g':w+'kg'}</div>`;
    btn.onclick=()=>{btn.classList.add('used');addLog(`üíâ ${drug.name} ${vol.toFixed(2)}mL Êäï‰∏é`);};
    g.appendChild(btn);
  });
}

// ===================================================================
//  EVENT / DRUG RECORDING
// ===================================================================
function recordEvent(btn){
  if(!btn||btn.classList.contains('recorded'))return;
  const name=btn.dataset.event,now=new Date(),ts=now.toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
  btn.classList.add('recorded');btn.innerHTML=`${name}<span class="event-time">${ts}</span>`;
  state.events.push({name,time:now});addLog(`üìã ${name} (${ts})`);
}
function recordDrugAdmin(){
  const name=document.getElementById('drugAdminName').value;
  const dose=document.getElementById('drugAdminDose').value.trim();
  const route=document.getElementById('drugAdminRoute').value;
  if(!name){alert('Ëñ¨Ââ§„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');return;}
  addLog(`üíä ${name} ${dose} ${route}`);
  document.getElementById('drugAdminDose').value='';
}

// ===================================================================
//  VOICE INPUT
// ===================================================================
function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){alert('Èü≥Â£∞Ë™çË≠òÈùûÂØæÂøú');return;}
  if(state.voiceActive){state.voiceActive=false;if(state.recognition)state.recognition.stop();document.getElementById('btnVoice').classList.remove('recording');document.getElementById('voiceLabel').textContent='Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã';return;}
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;state.recognition=new SR();state.recognition.lang='ja-JP';state.recognition.continuous=true;state.recognition.interimResults=false;
  state.recognition.onresult=(e)=>{for(let i=e.resultIndex;i<e.results.length;i++){if(e.results[i].isFinal){const t=e.results[i][0].transcript,tm=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});document.getElementById('voiceLog').innerHTML=`<p><span class="log-time">${tm}</span>${t}</p>`+document.getElementById('voiceLog').innerHTML;addLog(`üé§ "${t}"`);}}};
  state.recognition.onerror=()=>{state.voiceActive=false;document.getElementById('btnVoice').classList.remove('recording');document.getElementById('voiceLabel').textContent='Èü≥Â£∞ÂÖ•ÂäõÈñãÂßã';};
  state.recognition.onend=()=>{if(state.voiceActive)state.recognition.start();};
  state.recognition.start();state.voiceActive=true;document.getElementById('btnVoice').classList.add('recording');document.getElementById('voiceLabel').textContent='Èå≤Èü≥‰∏≠... „Çø„ÉÉ„Éó„ÅßÂÅúÊ≠¢';
}

// ===================================================================
//  CHART
// ===================================================================
let vitalChart=null;
function initChart(){
  const ctx=document.getElementById('vitalChart').getContext('2d');
  const predPlugin={id:'predZone',afterDraw(ch){
    const lb=ch.data.labels;if(lb.length<2)return;const li=lb.length-2,pi=lb.length-1;
    const xs=ch.scales.x,ys=ch.scales.y;if(!xs||li<0)return;
    const x0=xs.getPixelForValue(li),x1=xs.getPixelForValue(pi),yt=ys.top,yb=ys.bottom,c=ch.ctx;
    c.save();c.fillStyle='rgba(59,130,246,0.05)';c.fillRect(x0,yt,x1-x0,yb-yt);
    c.strokeStyle='rgba(59,130,246,0.3)';c.lineWidth=1;c.setLineDash([4,4]);c.beginPath();c.moveTo(x1,yt);c.lineTo(x1,yb);c.stroke();
    c.fillStyle='rgba(59,130,246,0.5)';c.font='10px -apple-system,sans-serif';c.textAlign='center';c.fillText('Ê¨°ÂõûË®àÊ∏¨',x1,yt+12);c.restore();
  }};
  vitalChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
    {label:'HR',data:[],borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',tension:0.3,pointRadius:3,borderWidth:2},
    {label:'SpO2',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',tension:0.3,pointRadius:3,borderWidth:2},
    {label:'RR',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.1)',tension:0.3,pointRadius:3,borderWidth:2},
    {label:'EtCO2',data:[],borderColor:'#8b5cf6',backgroundColor:'rgba(139,92,246,0.1)',tension:0.3,pointRadius:3,borderWidth:2},
    {label:'MAP',data:[],borderColor:'#10b981',backgroundColor:'rgba(16,185,129,0.1)',tension:0.3,pointRadius:3,borderWidth:2},
  ]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{position:'top',labels:{color:'#8892a8',usePointStyle:true,pointStyle:'circle',padding:12,font:{size:10,weight:'600'}}}},scales:{x:{grid:{color:'rgba(42,53,80,0.5)'},ticks:{color:'#5a6478',font:{size:9}}},y:{grid:{color:'rgba(42,53,80,0.5)'},ticks:{color:'#5a6478',font:{size:9}},min:0,max:200}},animation:{duration:400}},plugins:[predPlugin]});
}
function addVitalToChart(d){
  const t=new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});state.timeLabels.push(t);
  state.vitals.hr.push(d.hr);state.vitals.spo2.push(d.spo2);state.vitals.rr.push(d.rr);state.vitals.etco2.push(d.etco2);state.vitals.mean.push(d.mean);
  const M=30;if(state.timeLabels.length>M){state.timeLabels.shift();state.vitals.hr.shift();state.vitals.spo2.shift();state.vitals.rr.shift();state.vitals.etco2.shift();state.vitals.mean.shift();}
  const pl=[...state.timeLabels,'+5min'];
  vitalChart.data.labels=pl;
  vitalChart.data.datasets[0].data=[...state.vitals.hr,null];
  vitalChart.data.datasets[1].data=[...state.vitals.spo2,null];
  vitalChart.data.datasets[2].data=[...state.vitals.rr,null];
  vitalChart.data.datasets[3].data=[...state.vitals.etco2,null];
  vitalChart.data.datasets[4].data=[...state.vitals.mean,null];
  vitalChart.update();
}

// ===================================================================
//  CAMERA CAPTURE (Mock) + Thumbnail
// ===================================================================
function generateMockThumbnail(d) {
  const c = document.createElement('canvas');
  c.width = 160; c.height = 100;
  const ctx = c.getContext('2d');
  // Dark background
  ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0,0,160,100);
  // Green waveform simulation
  ctx.strokeStyle = '#00ff88'; ctx.lineWidth = 1.5; ctx.beginPath();
  for (let x = 0; x < 160; x++) { ctx.lineTo(x, 30 + Math.sin(x*0.15)*12 + Math.random()*4); }
  ctx.stroke();
  // Vitals text
  ctx.fillStyle = '#ef4444'; ctx.font = 'bold 14px sans-serif'; ctx.fillText(`HR ${d.hr}`, 8, 68);
  ctx.fillStyle = '#3b82f6'; ctx.fillText(`SpO2 ${d.spo2}`, 80, 68);
  ctx.fillStyle = '#10b981'; ctx.font = 'bold 12px sans-serif'; ctx.fillText(`${d.sys}/${d.dia}`, 8, 90);
  ctx.fillStyle = '#f59e0b'; ctx.fillText(`T${d.temp}`, 90, 90);
  return c.toDataURL('image/jpeg', 0.5);
}

function storeThumbnail(dataUrl) {
  const id = Date.now();
  state.capturedImages.push({ id, timestamp: new Date(), dataUrl, notes: '' });
  if (state.capturedImages.length > state.maxCapturedImages) {
    state.capturedImages.shift();
  }
  return id;
}

function handleCameraCapture(){
  var btn = document.getElementById('btnCapture');
  var input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    btn.classList.add('capturing');
    btn.innerHTML = '<span class="icon">‚è≥</span><span>Ëß£Êûê‰∏≠...</span>';
    var reader = new FileReader();
    reader.onload = function(ev) {
      var fullDataUrl = ev.target.result;
      // „Çµ„É†„Éç„Ç§„É´ÁîüÊàê
      var img = new Image();
      img.onload = function() {
        var thumbCanvas = document.createElement('canvas');
        thumbCanvas.width = 160; thumbCanvas.height = 100;
        var tCtx = thumbCanvas.getContext('2d');
        tCtx.drawImage(img, 0, 0, 160, 100);
        var thumbUrl = thumbCanvas.toDataURL('image/jpeg', 0.5);
        var captureId = storeThumbnail(thumbUrl);

        // APIÈÄÅ‰ø°Áî®„Å´„É™„Çµ„Ç§„Ç∫ÔºàÈÄö‰ø°ÈáèÂâäÊ∏õ: ÊúÄÂ§ß768pxÔºâ
        var apiCanvas = document.createElement('canvas');
        var scale = Math.min(768 / img.width, 768 / img.height, 1);
        apiCanvas.width = Math.round(img.width * scale);
        apiCanvas.height = Math.round(img.height * scale);
        var aCtx = apiCanvas.getContext('2d');
        aCtx.drawImage(img, 0, 0, apiCanvas.width, apiCanvas.height);
        var apiDataUrl = apiCanvas.toDataURL('image/jpeg', 0.8);

        // API„É¢„Éº„ÉâÂà§ÂÆö
        if (state.apiMode === 'ai' && state.apiKey) {
          callGeminiVision(apiDataUrl, captureId, btn);
        } else {
          // „Éá„É¢„É¢„Éº„Éâ
          var d = generateMockVitals(state.patient.species);
          applyVitalData(d, captureId, false);
          btn.classList.remove('capturing');
          btn.innerHTML = '<span class="icon">üì∏</span><span>„É¢„Éã„Çø„ÉºÊíÆÂΩ±</span>';
          resetTimer();
          if (state.apiMode === 'ai' && !state.apiKey) {
            addLog('‚ö† API„Ç≠„ÉºÊú™Ë®≠ÂÆö ‚Üí „Éá„É¢ÂÄ§„Çí‰ΩøÁî®');
          }
        }
      };
      img.src = fullDataUrl;
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

// ===================================================================
//  GEMINI VISION API
// ===================================================================
function getGeminiModelId() {
  if (state.apiModel === 'gemini-pro') return 'gemini-2.5-pro-preview-06-05';
  return 'gemini-2.0-flash';
}

function callGeminiVision(imageDataUrl, captureId, btn) {
  // base64ÈÉ®ÂàÜ„ÇíÊäΩÂá∫
  var parts = imageDataUrl.split(',');
  var mimeType = 'image/jpeg';
  var mtMatch = parts[0].match(/data:([^;]+)/);
  if (mtMatch) mimeType = mtMatch[1];
  var base64Data = parts[1];

  var modelId = getGeminiModelId();
  var prompt = '„Åì„ÅÆÁîªÂÉè„ÅØÂãïÁâ©ÁóÖÈô¢„ÅÆÈ∫ªÈÖî„É¢„Éã„Çø„ÉºÁîªÈù¢„Åß„Åô„ÄÇË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÊï∞ÂÄ§„ÇíË™≠„ÅøÂèñ„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
    'ÂøÖ„Åö‰ª•‰∏ã„ÅÆJSONÂΩ¢Âºè„ÅÆ„Åø„ÅßÂõûÁ≠î„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰ªñ„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÅØ‰∏çË¶Å„Åß„Åô„ÄÇ\n' +
    'Ë™≠„ÅøÂèñ„Çå„Å™„ÅÑÈ†ÖÁõÆ„ÅØnull„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n' +
    '{"hr":Êï∞ÂÄ§,"spo2":Êï∞ÂÄ§,"rr":Êï∞ÂÄ§,"etco2":Êï∞ÂÄ§,"sys":Êï∞ÂÄ§,"dia":Êï∞ÂÄ§,"temp":Êï∞ÂÄ§,"iso":Êï∞ÂÄ§}\n' +
    '- hr: ÂøÉÊãçÊï∞(bpm)\n- spo2: ÈÖ∏Á¥†È£ΩÂíåÂ∫¶(%)\n- rr: ÂëºÂê∏Êï∞\n- etco2: ÁµÇÊú´ÂëºÊ∞óCO2(mmHg)\n' +
    '- sys: ÂèéÁ∏ÆÊúüË°ÄÂúß(mmHg)\n- dia: Êã°ÂºµÊúüË°ÄÂúß(mmHg)\n- temp: ‰ΩìÊ∏©(‚ÑÉ)\n- iso: „Ç§„ÇΩ„Éï„É´„É©„É≥ÊøÉÂ∫¶(%)';

  var apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/' + modelId + ':generateContent?key=' + encodeURIComponent(state.apiKey);

  var body = JSON.stringify({
    contents: [{
      parts: [
        {
          inline_data: {
            mime_type: mimeType,
            data: base64Data
          }
        },
        {
          text: prompt
        }
      ]
    }],
    generationConfig: {
      maxOutputTokens: 256,
      temperature: 0.1
    }
  });

  var xhr = new XMLHttpRequest();
  xhr.open('POST', apiUrl, true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.timeout = 30000;

  xhr.onload = function() {
    btn.classList.remove('capturing');
    btn.innerHTML = '<span class="icon">üì∏</span><span>„É¢„Éã„Çø„ÉºÊíÆÂΩ±</span>';

    if (xhr.status === 200) {
      try {
        var resp = JSON.parse(xhr.responseText);
        var text = '';
        if (resp.candidates && resp.candidates.length > 0) {
          var parts2 = resp.candidates[0].content && resp.candidates[0].content.parts;
          if (parts2 && parts2.length > 0) {
            text = parts2[0].text || '';
          }
        }
        var vitals = parseVitalsFromAI(text);
        if (vitals) {
          applyVitalData(vitals, captureId, false);
          addLog('ü§ñ AIË™≠ÂèñÊàêÂäü (' + modelId + ')');
        } else {
          addLog('‚ö† AIÂøúÁ≠î„ÅÆ„Éë„Éº„ÇπÂ§±Êïó ‚Üí „Éá„É¢ÂÄ§‰ΩøÁî®');
          var d = generateMockVitals(state.patient.species);
          applyVitalData(d, captureId, false);
        }
      } catch(e) {
        addLog('‚ö† AIÂøúÁ≠î„Ç®„É©„Éº: ' + e.message);
        var d = generateMockVitals(state.patient.species);
        applyVitalData(d, captureId, false);
      }
    } else {
      var errMsg = 'HTTP ' + xhr.status;
      try {
        var errBody = JSON.parse(xhr.responseText);
        if (errBody.error && errBody.error.message) errMsg = errBody.error.message;
      } catch(e2) {}
      addLog('‚ö† API „Ç®„É©„Éº: ' + errMsg + ' ‚Üí „Éá„É¢ÂÄ§‰ΩøÁî®');
      var d = generateMockVitals(state.patient.species);
      applyVitalData(d, captureId, false);
    }
    resetTimer();
  };

  xhr.onerror = function() {
    btn.classList.remove('capturing');
    btn.innerHTML = '<span class="icon">üì∏</span><span>„É¢„Éã„Çø„ÉºÊíÆÂΩ±</span>';
    addLog('‚ö† APIÈÄö‰ø°Â§±ÊïóÔºà„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„ÉºÔºâ‚Üí „Éá„É¢ÂÄ§‰ΩøÁî®');
    var d = generateMockVitals(state.patient.species);
    applyVitalData(d, captureId, false);
    resetTimer();
  };

  xhr.ontimeout = function() {
    btn.classList.remove('capturing');
    btn.innerHTML = '<span class="icon">üì∏</span><span>„É¢„Éã„Çø„ÉºÊíÆÂΩ±</span>';
    addLog('‚ö† API „Çø„Ç§„É†„Ç¢„Ç¶„Éà ‚Üí „Éá„É¢ÂÄ§‰ΩøÁî®');
    var d = generateMockVitals(state.patient.species);
    applyVitalData(d, captureId, false);
    resetTimer();
  };

  xhr.send(body);
}

function parseVitalsFromAI(text) {
  // AIÂøúÁ≠î„Åã„ÇâJSON„ÇíÊäΩÂá∫
  try {
    // ```json ... ``` „ÇíÈô§Âéª
    var cleaned = text.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
    // JSON„Ç™„Éñ„Ç∏„Çß„ÇØ„ÉàÈÉ®ÂàÜ„ÇíÊäΩÂá∫
    var jsonMatch = cleaned.match(/\{[\s\S]*\}/);
    if (!jsonMatch) return null;
    var obj = JSON.parse(jsonMatch[0]);

    // Êï∞ÂÄ§„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØÔºã„Éá„Éï„Ç©„É´„ÉàË£úÂÆå
    var hr = (typeof obj.hr === 'number' && obj.hr > 0 && obj.hr < 500) ? Math.round(obj.hr) : null;
    var spo2 = (typeof obj.spo2 === 'number' && obj.spo2 > 0 && obj.spo2 <= 100) ? Math.round(obj.spo2) : null;
    var rr = (typeof obj.rr === 'number' && obj.rr > 0 && obj.rr < 200) ? Math.round(obj.rr) : null;
    var etco2 = (typeof obj.etco2 === 'number' && obj.etco2 > 0 && obj.etco2 < 150) ? Math.round(obj.etco2) : null;
    var sys = (typeof obj.sys === 'number' && obj.sys > 0 && obj.sys < 400) ? Math.round(obj.sys) : null;
    var dia = (typeof obj.dia === 'number' && obj.dia > 0 && obj.dia < 300) ? Math.round(obj.dia) : null;
    var temp = (typeof obj.temp === 'number' && obj.temp > 15 && obj.temp < 45) ? +obj.temp.toFixed(1) : null;
    var iso = (typeof obj.iso === 'number' && obj.iso >= 0 && obj.iso < 10) ? +obj.iso.toFixed(1) : null;

    // Â∞ë„Å™„Åè„Å®„ÇÇ2È†ÖÁõÆ‰ª•‰∏äË™≠„ÇÅ„Å¶„ÅÑ„Çå„Å∞ÊàêÂäü„Å®„Åô„Çã
    var count = [hr, spo2, rr, etco2, sys, dia, temp, iso].filter(function(v) { return v !== null; }).length;
    if (count < 2) return null;

    // nullÈ†ÖÁõÆ„ÅØÂâçÂõûÂÄ§„ÅßË£úÂÆå
    var lastHr = state.vitals.hr.length > 0 ? state.vitals.hr[state.vitals.hr.length - 1] : 0;
    var lastSpo2 = state.vitals.spo2.length > 0 ? state.vitals.spo2[state.vitals.spo2.length - 1] : 0;
    var lastRr = state.vitals.rr.length > 0 ? state.vitals.rr[state.vitals.rr.length - 1] : 0;
    var lastEtco2 = state.vitals.etco2.length > 0 ? state.vitals.etco2[state.vitals.etco2.length - 1] : 0;
    var lastSys = state.vitals.sys.length > 0 ? state.vitals.sys[state.vitals.sys.length - 1] : 0;
    var lastDia = state.vitals.dia.length > 0 ? state.vitals.dia[state.vitals.dia.length - 1] : 0;
    var lastTemp = state.vitals.temp.length > 0 ? state.vitals.temp[state.vitals.temp.length - 1] : 0;

    var finalSys = sys !== null ? sys : lastSys;
    var finalDia = dia !== null ? dia : lastDia;
    var mean = (finalSys > 0 && finalDia > 0) ? Math.round(finalDia + (finalSys - finalDia) / 3) : 0;

    return {
      hr: hr !== null ? hr : lastHr,
      spo2: spo2 !== null ? spo2 : lastSpo2,
      rr: rr !== null ? rr : lastRr,
      etco2: etco2 !== null ? etco2 : lastEtco2,
      sys: finalSys,
      dia: finalDia,
      mean: mean,
      temp: temp !== null ? temp : lastTemp,
      iso: iso !== null ? iso : 0
    };
  } catch(e) {
    return null;
  }
}

// ===================================================================
//  API SETTINGS MANAGEMENT
// ===================================================================
function loadApiSettings() {
  try {
    var key = localStorage.getItem('vetanes_api_key');
    var model = localStorage.getItem('vetanes_api_model');
    var mode = localStorage.getItem('vetanes_api_mode');
    if (key) state.apiKey = key;
    if (model) state.apiModel = model;
    if (mode) state.apiMode = mode;
  } catch(e) { console.warn('API settings load error:', e); }
}

function saveApiSettings() {
  var keyInput = document.getElementById('inputApiKey');
  var modelSelect = document.getElementById('selectApiModel');
  if (keyInput) state.apiKey = keyInput.value.trim();
  if (modelSelect) state.apiModel = modelSelect.value;
  try {
    localStorage.setItem('vetanes_api_key', state.apiKey);
    localStorage.setItem('vetanes_api_model', state.apiModel);
    localStorage.setItem('vetanes_api_mode', state.apiMode);
  } catch(e) {}
  alert('APIË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü ‚úÖ');
}

function restoreApiSettingsUI() {
  var keyInput = document.getElementById('inputApiKey');
  var modelSelect = document.getElementById('selectApiModel');
  if (keyInput && state.apiKey) keyInput.value = state.apiKey;
  if (modelSelect && state.apiModel) modelSelect.value = state.apiModel;
  setApiMode(state.apiMode);
}

function setApiMode(mode) {
  state.apiMode = mode;
  var btnAI = document.getElementById('btnModeAI');
  var btnDemo = document.getElementById('btnModeDemo');
  var desc = document.getElementById('apiModeDesc');
  if (mode === 'ai') {
    if (btnAI) { btnAI.style.background = 'rgba(16,185,129,0.15)'; btnAI.style.borderColor = 'var(--accent-green)'; btnAI.style.color = 'var(--accent-green)'; }
    if (btnDemo) { btnDemo.style.background = 'var(--bg-card)'; btnDemo.style.borderColor = 'var(--border)'; btnDemo.style.color = 'var(--text-secondary)'; }
    if (desc) desc.textContent = '„É¢„Éã„Çø„ÉºÊíÆÂΩ±ÊôÇ„Å´AI„Åå„Éê„Ç§„Çø„É´ÂÄ§„ÇíË™≠„ÅøÂèñ„Çä„Åæ„ÅôÔºàAPI„Ç≠„ÉºÂøÖÈ†àÔºâ';
  } else {
    if (btnDemo) { btnDemo.style.background = 'rgba(245,158,11,0.15)'; btnDemo.style.borderColor = 'var(--accent-yellow)'; btnDemo.style.color = 'var(--accent-yellow)'; }
    if (btnAI) { btnAI.style.background = 'var(--bg-card)'; btnAI.style.borderColor = 'var(--border)'; btnAI.style.color = 'var(--text-secondary)'; }
    if (desc) desc.textContent = '„É©„É≥„ÉÄ„É†„Å™„Éá„É¢ÂÄ§„ÇíÁîüÊàê„Åó„Åæ„ÅôÔºàAPI„Ç≠„Éº‰∏çË¶ÅÔºâ';
  }
  try { localStorage.setItem('vetanes_api_mode', mode); } catch(e) {}
}

function toggleApiKeyVisibility() {
  var input = document.getElementById('inputApiKey');
  var btn = document.getElementById('btnToggleKey');
  if (!input) return;
  if (input.type === 'password') {
    input.type = 'text';
    if (btn) btn.textContent = 'üôà';
  } else {
    input.type = 'password';
    if (btn) btn.textContent = 'üëÅ';
  }
}

function testApiConnection() {
  var resultEl = document.getElementById('apiTestResult');
  var keyInput = document.getElementById('inputApiKey');
  var key = keyInput ? keyInput.value.trim() : '';
  if (!key) {
    if (resultEl) {
      resultEl.style.display = 'block';
      resultEl.style.background = 'rgba(239,68,68,0.1)';
      resultEl.style.color = 'var(--accent-red)';
      resultEl.textContent = '‚ùå API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
    }
    return;
  }

  if (resultEl) {
    resultEl.style.display = 'block';
    resultEl.style.background = 'rgba(59,130,246,0.1)';
    resultEl.style.color = 'var(--accent-blue)';
    resultEl.textContent = '‚è≥ Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...';
  }

  var modelSelect = document.getElementById('selectApiModel');
  var modelVal = modelSelect ? modelSelect.value : 'gemini-flash';
  var modelId = modelVal === 'gemini-pro' ? 'gemini-2.5-pro-preview-06-05' : 'gemini-2.0-flash';

  var apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/' + modelId + ':generateContent?key=' + encodeURIComponent(key);

  var body = JSON.stringify({
    contents: [{ parts: [{ text: 'Reply with only: OK' }] }],
    generationConfig: { maxOutputTokens: 16 }
  });

  var xhr = new XMLHttpRequest();
  xhr.open('POST', apiUrl, true);
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.timeout = 15000;

  xhr.onload = function() {
    if (!resultEl) return;
    resultEl.style.display = 'block';
    if (xhr.status === 200) {
      resultEl.style.background = 'rgba(16,185,129,0.1)';
      resultEl.style.color = 'var(--accent-green)';
      resultEl.textContent = '‚úÖ Êé•Á∂öÊàêÂäüÔºÅAPI „ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàmodel: ' + modelId + 'Ôºâ';
    } else {
      var errMsg = 'HTTP ' + xhr.status;
      try {
        var errBody = JSON.parse(xhr.responseText);
        if (errBody.error && errBody.error.message) errMsg = errBody.error.message;
      } catch(e2) {}
      resultEl.style.background = 'rgba(239,68,68,0.1)';
      resultEl.style.color = 'var(--accent-red)';
      resultEl.textContent = '‚ùå „Ç®„É©„Éº: ' + errMsg;
    }
  };

  xhr.onerror = function() {
    if (!resultEl) return;
    resultEl.style.display = 'block';
    resultEl.style.background = 'rgba(239,68,68,0.1)';
    resultEl.style.color = 'var(--accent-red)';
    resultEl.textContent = '‚ùå „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº';
  };

  xhr.ontimeout = function() {
    if (!resultEl) return;
    resultEl.style.display = 'block';
    resultEl.style.background = 'rgba(239,68,68,0.1)';
    resultEl.style.color = 'var(--accent-red)';
    resultEl.textContent = '‚ùå „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÔºà15ÁßíÔºâ';
  };

  xhr.send(body);
}

function generateMockVitals(sp){
  const bases={cat:{hr:160,spo2:98,rr:20,etco2:38,sys:120,dia:70,temp:37.5,iso:1.5},dog:{hr:100,spo2:98,rr:14,etco2:40,sys:120,dia:75,temp:38.0,iso:1.5},rabbit:{hr:220,spo2:97,rr:40,etco2:35,sys:100,dia:60,temp:38.5,iso:2.0},ferret:{hr:250,spo2:97,rr:30,etco2:36,sys:110,dia:65,temp:38.0,iso:2.0},guinea_pig:{hr:280,spo2:96,rr:50,etco2:34,sys:90,dia:55,temp:38.0,iso:2.0},hamster:{hr:350,spo2:96,rr:60,etco2:32,sys:80,dia:50,temp:37.0,iso:2.5},bird:{hr:300,spo2:95,rr:25,etco2:35,sys:130,dia:80,temp:40.0,iso:2.0},reptile:{hr:30,spo2:90,rr:6,etco2:30,sys:80,dia:50,temp:28.0,iso:2.0}};
  const b=bases[sp]||bases.dog;
  const r=(v,rng)=>Math.round(v+(Math.random()-0.5)*rng);
  const rf=(v,rng)=>+(v+(Math.random()-0.5)*rng).toFixed(1);
  const sys=r(b.sys,40),dia=r(b.dia,30);
  return{hr:r(b.hr,40),spo2:Math.min(100,r(b.spo2,6)),rr:Math.max(1,r(b.rr,10)),etco2:r(b.etco2,15),sys,dia,mean:Math.round(dia+(sys-dia)/3),temp:rf(b.temp,2),iso:rf(b.iso,0.8)};
}

function applyVitalData(d, captureId, isManual){
  document.getElementById('valHR').textContent=d.hr;document.getElementById('valSpO2').textContent=d.spo2;
  document.getElementById('valRR').textContent=d.rr;document.getElementById('valEtCO2').textContent=d.etco2;
  document.getElementById('valSys').textContent=d.sys;document.getElementById('valDia').textContent=d.dia;
  document.getElementById('valMean').textContent=d.mean;document.getElementById('valTemp').textContent=d.temp;
  document.getElementById('valIso').textContent=d.iso;
  addVitalToChart(d);
  state.vitals.sys.push(d.sys);state.vitals.dia.push(d.dia);state.vitals.temp.push(d.temp);
  const prefix = isManual ? '‚úèÔ∏è' : 'üìä';
  addLog(`${prefix} HR:${d.hr} SpO2:${d.spo2} RR:${d.rr} EtCO2:${d.etco2} BP:${d.sys}/${d.dia}(${d.mean}) T:${d.temp}`, captureId || null);
  checkAlarms(d);
}

// ===================================================================
//  ALARMS
// ===================================================================
function checkAlarms(d){
  if(d.mean<60){document.getElementById('vitalBP').classList.add('alert');showAlert('‰ΩéË°ÄÂúßË≠¶Âëä',`MAP ${d.mean} mmHg\nÊòáÂúßÂâ§„ÅÆÊäï‰∏é„ÇíÊ§úË®é„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);}else{document.getElementById('vitalBP').classList.remove('alert');}
  if((d.sys-d.dia)<15){showAlert('ËÑàÂúßÁï∞Â∏∏',`ËÑàÂúß: ${d.sys-d.dia}mmHg\n„Ç´„Éï„Çµ„Ç§„Ç∫„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);}
  if(d.spo2<90){document.getElementById('vitalSpO2').classList.add('alert');showAlert('SpO2‰Ωé‰∏ã',`SpO2: ${d.spo2}%`);}else{document.getElementById('vitalSpO2').classList.remove('alert');}
  const hrLow=state.patient.species==='cat'?100:state.patient.species==='rabbit'?150:60;
  document.getElementById('vitalHR').classList.toggle('alert',d.hr<hrLow);
  document.getElementById('vitalEtCO2').classList.toggle('alert',d.etco2>50||d.etco2<25);
  document.getElementById('vitalTemp').classList.toggle('alert',d.temp<(state.patient.species==='reptile'?22:36));
}
function showAlert(t,m){
  const c=document.getElementById('alertContainer'),o=document.createElement('div');o.className='alert-overlay';
  o.innerHTML=`<div class="alert-box"><div class="alert-icon">üö®</div><div class="alert-title">${t}</div><div class="alert-msg">${m.replace(/\n/g,'<br>')}</div><button class="btn-dismiss" onclick="this.closest('.alert-overlay').remove()">Á¢∫Ë™ç</button></div>`;
  c.appendChild(o);speak(t);
}

// ===================================================================
//  LOG (with thumbnail + edit support)
// ===================================================================
function addLog(m, captureId) {
  const l = document.getElementById('eventLog');
  if (!l) return;
  const t = new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  const logId = 'log_' + Date.now() + '_' + Math.random().toString(36).substr(2,4);

  let thumbHtml = '';
  if (captureId) {
    const img = state.capturedImages.find(c => c.id === captureId);
    if (img) thumbHtml = `<img src="${img.dataUrl}" class="log-thumb" loading="lazy">`;
  }

  state.logEntries[logId] = { text: m, captureId: captureId || null, note: '' };

  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.id = logId;
  entry.onclick = () => editLogEntry(logId);
  entry.innerHTML = `${thumbHtml}<span class="log-time">${t}</span><span class="log-text">${m}<span class="log-note" id="note_${logId}"></span></span>`;
  l.insertBefore(entry, l.firstChild);
}

function editLogEntry(logId) {
  const entry = state.logEntries[logId];
  if (!entry) return;

  const c = document.getElementById('alertContainer');
  const o = document.createElement('div'); o.className='log-edit-overlay';

  let imgHtml = '';
  if (entry.captureId) {
    const img = state.capturedImages.find(c => c.id === entry.captureId);
    if (img) imgHtml = `<img src="${img.dataUrl}" class="log-edit-img">`;
  }

  o.innerHTML = `<div class="log-edit-popup">
    <h3>üìù „É≠„Ç∞ËøΩË®ò„ÉªÁ∑®ÈõÜ</h3>
    ${imgHtml}
    <div class="log-edit-text">${entry.text}</div>
    <textarea id="logEditNote" placeholder="ËøΩË®ò„É°„É¢„ÇíÂÖ•Âäõ...">${entry.note}</textarea>
    <div class="btn-row">
      <button class="btn-cancel" onclick="this.closest('.log-edit-overlay').remove()">„Ç≠„É£„É≥„Çª„É´</button>
      <button class="btn-save" onclick="saveLogNote('${logId}')">‰øùÂ≠ò</button>
    </div>
  </div>`;
  c.appendChild(o);

  // Focus textarea
  setTimeout(function() { var el = document.getElementById('logEditNote'); if(el) el.focus(); }, 100);
}

function saveLogNote(logId) {
  var noteEl2 = document.getElementById('logEditNote');
  var note = (noteEl2 && noteEl2.value) ? noteEl2.value.trim() : '';
  if (state.logEntries[logId]) {
    state.logEntries[logId].note = note;
  }
  var noteEl = document.getElementById('note_' + logId);
  if (noteEl) {
    noteEl.textContent = note ? ' [' + note + ']' : '';
  }
  var overlay = document.querySelector('.log-edit-overlay');
  if (overlay) overlay.remove();
}

// ===================================================================
//  MONITOR CALIBRATION
// ===================================================================
const CALIB_PARAMS = [
  { key: 'HR', label: 'HR (ÂøÉÊãçÊï∞)', color: '#ef4444' },
  { key: 'SPO2', label: 'SpO2', color: '#3b82f6' },
  { key: 'RR', label: 'RR (ÂëºÂê∏Êï∞)', color: '#f59e0b' },
  { key: 'ETCO2', label: 'EtCO2', color: '#8b5cf6' },
  { key: 'BP', label: 'Ë°ÄÂúß (BP)', color: '#10b981' },
  { key: 'TEMP', label: '‰ΩìÊ∏©', color: '#06b6d4' },
  { key: 'ISO', label: 'ISO', color: '#94a3b8' },
];

const calibState = {
  imageDataUrl: null,
  boxes: [],  // { id, param, x, y, w, h } ‚Äî in % relative to image
  profiles: [],  // { id, name, imageDataUrl, boxes, createdAt }
  activeProfileId: null,
  dragState: null,  // { boxId, type:'move'|'resize', startX, startY, origBox }
  nextBoxId: 1,
};

// Load profiles from localStorage on init
function loadCalibProfiles() {
  try {
    const saved = localStorage.getItem('vetanes_calib_profiles');
    if (saved) {
      calibState.profiles = JSON.parse(saved) || [];
      var allIds = [];
      calibState.profiles.forEach(function(p) { (p.boxes || []).forEach(function(b) { allIds.push(b.id + 1); }); });
      calibState.nextBoxId = allIds.length > 0 ? Math.max.apply(null, [1].concat(allIds)) : 1;
    }
    const activeId = localStorage.getItem('vetanes_calib_active');
    if (activeId) calibState.activeProfileId = activeId;
  } catch(e) { console.warn('Calib profile load error:', e); }
}

function saveCalibProfilesToStorage() {
  try {
    localStorage.setItem('vetanes_calib_profiles', JSON.stringify(calibState.profiles));
    if (calibState.activeProfileId) localStorage.setItem('vetanes_calib_active', calibState.activeProfileId);
  } catch(e) { console.warn('Calib profile save error:', e); }
}

function openSettings(tabId) {
  // Show screen FIRST, then load data
  var screen = document.getElementById('settingsScreen');
  if (!screen) { alert('settingsScreen not found'); return; }
  screen.style.display = 'flex';
  try {
    loadCalibProfiles();
    renderCalibProfiles();
    if (calibState.activeProfileId) {
      var prof = calibState.profiles.find(function(p) { return p.id === calibState.activeProfileId; });
      if (prof) loadProfileIntoEditor(prof);
    }
    if (tabId) switchSettingsTab(tabId);
  } catch(e) {
    console.error('openSettings error:', e);
  }
}
// Backward-compatible alias
function openCalibration() { openSettings('tabMonitor'); }

function closeSettings() {
  try {
    document.getElementById('settingsScreen').style.display = 'none';
    removeParamDropdown();
  } catch(e) { console.error('closeSettings error:', e); }
}
function closeCalibration() { closeSettings(); }

function switchSettingsTab(tabId) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.remove('active'));
  const btn = document.querySelector(`.settings-tab[data-tab="${tabId}"]`);
  const content = document.getElementById(tabId);
  if (btn) btn.classList.add('active');
  if (content) content.classList.add('active');
  if (tabId === 'tabDrugMaster') renderDrugMasterEditor();
  if (tabId === 'tabApiSettings') restoreApiSettingsUI();
}

function captureCalibImage() {
  // Use camera API or mock
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.capture = 'environment';
  input.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      calibState.imageDataUrl = ev.target.result;
      showCalibImage(ev.target.result);
    };
    reader.readAsDataURL(file);
  };
  input.click();
}

function showCalibImage(dataUrl) {
  const img = document.getElementById('calibImage');
  const ph = document.getElementById('calibPlaceholder');
  const overlay = document.getElementById('calibOverlay');
  const area = document.getElementById('calibImageArea');

  img.src = dataUrl;
  img.style.display = 'block';
  ph.style.display = 'none';
  overlay.style.display = 'block';
  area.classList.add('has-image');

  document.getElementById('btnAddBox').style.display = 'block';

  // If no boxes, add default ones
  if (calibState.boxes.length === 0) {
    addDefaultBoxes();
  }
  renderAllBoxes();
  renderBoxList();
}

function addDefaultBoxes() {
  calibState.boxes = [
    { id: calibState.nextBoxId++, param: 'HR', x: 5, y: 5, w: 20, h: 15 },
    { id: calibState.nextBoxId++, param: 'SPO2', x: 5, y: 25, w: 20, h: 15 },
    { id: calibState.nextBoxId++, param: 'BP', x: 30, y: 5, w: 25, h: 15 },
    { id: calibState.nextBoxId++, param: 'ETCO2', x: 30, y: 25, w: 20, h: 15 },
    { id: calibState.nextBoxId++, param: 'RR', x: 60, y: 5, w: 20, h: 15 },
    { id: calibState.nextBoxId++, param: 'TEMP', x: 60, y: 25, w: 20, h: 15 },
  ];
}

function addCalibBox() {
  if (!calibState.imageDataUrl) return;
  // Find unused param
  const usedParams = calibState.boxes.map(b => b.param);
  const available = CALIB_PARAMS.filter(p => !usedParams.includes(p.key));
  const param = available.length > 0 ? available[0].key : 'HR';

  calibState.boxes.push({
    id: calibState.nextBoxId++,
    param, x: 40, y: 40, w: 18, h: 12,
  });
  renderAllBoxes();
  renderBoxList();
}

function deleteCalibBox(boxId) {
  calibState.boxes = calibState.boxes.filter(b => b.id !== boxId);
  renderAllBoxes();
  renderBoxList();
  removeParamDropdown();
}

function renderAllBoxes() {
  const overlay = document.getElementById('calibOverlay');
  // Remove old boxes (keep dropdown if present)
  overlay.querySelectorAll('.calib-box').forEach(el => el.remove());

  calibState.boxes.forEach(box => {
    const el = document.createElement('div');
    el.className = 'calib-box';
    el.dataset.param = box.param;
    el.dataset.boxId = box.id;
    el.style.left = box.x + '%';
    el.style.top = box.y + '%';
    el.style.width = box.w + '%';
    el.style.height = box.h + '%';

    const paramInfo = CALIB_PARAMS.find(p => p.key === box.param) || CALIB_PARAMS[0];

    el.innerHTML = `
      <span class="box-label" onclick="showParamDropdown(event, ${box.id})">${paramInfo.label}</span>
      <span class="box-delete" onclick="deleteCalibBox(${box.id})">‚úï</span>
      <span class="box-resize" data-box-id="${box.id}"></span>
    `;

    // Touch/mouse events for dragging
    el.addEventListener('pointerdown', (e) => startBoxDrag(e, box.id, 'move'));
    const resizeHandle = el.querySelector('.box-resize');
    if (resizeHandle) {
      resizeHandle.addEventListener('pointerdown', (e) => {
        e.stopPropagation();
        startBoxDrag(e, box.id, 'resize');
      });
    }

    overlay.appendChild(el);
  });
}

function startBoxDrag(e, boxId, type) {
  e.preventDefault();
  const overlay = document.getElementById('calibOverlay');
  const rect = overlay.getBoundingClientRect();
  const box = calibState.boxes.find(b => b.id === boxId);
  if (!box) return;

  calibState.dragState = {
    boxId, type,
    startX: e.clientX, startY: e.clientY,
    origBox: { ...box },
    overlayW: rect.width, overlayH: rect.height,
  };

  const onMove = (ev) => handleBoxDrag(ev);
  const onUp = () => {
    document.removeEventListener('pointermove', onMove);
    document.removeEventListener('pointerup', onUp);
    calibState.dragState = null;
    renderBoxList();
  };

  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
}

function handleBoxDrag(e) {
  const ds = calibState.dragState;
  if (!ds) return;

  const dx = ((e.clientX - ds.startX) / ds.overlayW) * 100;
  const dy = ((e.clientY - ds.startY) / ds.overlayH) * 100;
  const box = calibState.boxes.find(b => b.id === ds.boxId);
  if (!box) return;

  if (ds.type === 'move') {
    box.x = Math.max(0, Math.min(100 - box.w, ds.origBox.x + dx));
    box.y = Math.max(0, Math.min(100 - box.h, ds.origBox.y + dy));
  } else {
    box.w = Math.max(5, Math.min(100 - box.x, ds.origBox.w + dx));
    box.h = Math.max(4, Math.min(100 - box.y, ds.origBox.h + dy));
  }

  // Update DOM directly for performance
  const el = document.querySelector(`.calib-box[data-box-id="${ds.boxId}"]`);
  if (el) {
    el.style.left = box.x + '%';
    el.style.top = box.y + '%';
    el.style.width = box.w + '%';
    el.style.height = box.h + '%';
  }
}

function showParamDropdown(e, boxId) {
  e.stopPropagation();
  removeParamDropdown();

  const box = calibState.boxes.find(b => b.id === boxId);
  if (!box) return;

  const dd = document.createElement('div');
  dd.className = 'calib-param-select';
  dd.id = 'calibParamDropdown';

  CALIB_PARAMS.forEach(p => {
    const btn = document.createElement('button');
    btn.innerHTML = `<span class="param-dot" style="background:${p.color}"></span>${p.label}`;
    btn.onclick = (ev) => {
      ev.stopPropagation();
      box.param = p.key;
      renderAllBoxes();
      renderBoxList();
      removeParamDropdown();
    };
    dd.appendChild(btn);
  });

  // Position near the clicked label
  const overlay = document.getElementById('calibOverlay');
  const overlayRect = overlay.getBoundingClientRect();
  const labelRect = e.target.getBoundingClientRect();
  dd.style.left = (labelRect.left - overlayRect.left) + 'px';
  dd.style.top = (labelRect.bottom - overlayRect.top + 4) + 'px';

  overlay.appendChild(dd);

  // Close on outside click
  setTimeout(() => {
    document.addEventListener('pointerdown', closeDDHandler, { once: true });
  }, 50);
}

function closeDDHandler(e) {
  const dd = document.getElementById('calibParamDropdown');
  if (dd && !dd.contains(e.target)) {
    removeParamDropdown();
  }
}

function removeParamDropdown() {
  var dd = document.getElementById('calibParamDropdown');
  if (dd) dd.remove();
}

function renderBoxList() {
  const list = document.getElementById('calibBoxList');
  if (calibState.boxes.length === 0) {
    list.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:8px;">„É™„Éï„Ç°„É¨„É≥„ÇπÁîªÂÉè„ÇíÊíÆÂΩ±Âæå„ÄÅ<br>Êû†„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>';
    return;
  }
  list.innerHTML = '';
  calibState.boxes.forEach(box => {
    const paramInfo = CALIB_PARAMS.find(p => p.key === box.param) || CALIB_PARAMS[0];
    const item = document.createElement('div');
    item.className = 'calib-box-item';
    item.innerHTML = `
      <span class="param-dot" style="background:${paramInfo.color}"></span>
      <span class="param-name">${paramInfo.label}</span>
      <span class="param-coords">${Math.round(box.x)},${Math.round(box.y)} ${Math.round(box.w)}√ó${Math.round(box.h)}</span>
    `;
    list.appendChild(item);
  });
}

// ===== PROFILE SAVE/LOAD =====
function saveCalibProfile() {
  const nameInput = document.getElementById('calibProfileName');
  const name = nameInput.value.trim() || `„Éó„É≠„Éï„Ç°„Ç§„É´ ${calibState.profiles.length + 1}`;

  if (!calibState.imageDataUrl) {
    alert('„É™„Éï„Ç°„É¨„É≥„ÇπÁîªÂÉè„ÇíÊíÆÂΩ±„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }
  if (calibState.boxes.length === 0) {
    alert('Ë™≠ÂèñÊû†„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
    return;
  }

  // Compress image for storage
  const compImg = compressCalibImage(calibState.imageDataUrl, 320, 200);

  const profile = {
    id: 'prof_' + Date.now(),
    name,
    imageDataUrl: compImg,
    boxes: JSON.parse(JSON.stringify(calibState.boxes)),
    createdAt: new Date().toISOString(),
  };

  calibState.profiles.push(profile);
  calibState.activeProfileId = profile.id;
  saveCalibProfilesToStorage();
  renderCalibProfiles();
  nameInput.value = '';
}

function compressCalibImage(dataUrl, maxW, maxH) {
  try {
    const c = document.createElement('canvas');
    c.width = maxW; c.height = maxH;
    const ctx = c.getContext('2d');
    // Simple compression: just create small canvas with placeholder
    ctx.fillStyle = '#1a1a2e'; ctx.fillRect(0,0,maxW,maxH);
    ctx.fillStyle = '#8892a8'; ctx.font = '12px sans-serif';
    ctx.fillText('Monitor Ref', 10, 20);
    return c.toDataURL('image/jpeg', 0.5);
  } catch(e) {
    console.warn('compressCalibImage error:', e);
    return dataUrl; // fallback: return original
  }
}

function loadProfileIntoEditor(profile) {
  calibState.imageDataUrl = profile.imageDataUrl;
  calibState.boxes = JSON.parse(JSON.stringify(profile.boxes));
  calibState.activeProfileId = profile.id;
  // Ensure nextBoxId is higher than any existing
  const maxId = Math.max(0, ...calibState.boxes.map(b => b.id));
  calibState.nextBoxId = Math.max(calibState.nextBoxId, maxId + 1);

  showCalibImage(profile.imageDataUrl);
  document.getElementById('calibProfileName').value = profile.name;
  renderCalibProfiles();
}

function deleteCalibProfile(profId) {
  calibState.profiles = calibState.profiles.filter(p => p.id !== profId);
  if (calibState.activeProfileId === profId) {
    calibState.activeProfileId = null;
  }
  saveCalibProfilesToStorage();
  renderCalibProfiles();
}

function renderCalibProfiles() {
  const list = document.getElementById('calibProfileList');
  if (!list) return;
  list.innerHTML = '';

  calibState.profiles.forEach(prof => {
    const item = document.createElement('div');
    item.className = 'calib-profile-item' + (calibState.activeProfileId === prof.id ? ' active' : '');
    item.innerHTML = `
      <span class="profile-name">${prof.name}</span>
      <span class="profile-count">${prof.boxes.length}Êû†</span>
      <span class="profile-delete" onclick="event.stopPropagation(); deleteCalibProfile('${prof.id}')">üóë</span>
    `;
    item.onclick = () => {
      loadProfileIntoEditor(prof);
      calibState.activeProfileId = prof.id;
      saveCalibProfilesToStorage();
    };
    list.appendChild(item);
  });
}

// Get active calibration profile for use during capture
function getActiveCalibProfile() {
  if (!calibState.activeProfileId) return null;
  return calibState.profiles.find(p => p.id === calibState.activeProfileId) || null;
}

// ===================================================================
//  DRUG MASTER EDITOR
// ===================================================================
const PREMED_MASTER_DEFAULTS = JSON.parse(JSON.stringify(PREMED_MASTER));

function loadDrugMasterFromStorage() {
  try {
    const data = localStorage.getItem('vetanes_drug_master_custom');
    if (data) {
      const custom = JSON.parse(data);
      Object.keys(custom).forEach(sp => {
        if (PREMED_MASTER[sp] !== undefined) {
          PREMED_MASTER[sp] = custom[sp];
        }
      });
    }
  } catch(e) { console.warn('Drug master load error:', e); }
}

function saveDrugMasterToStorage() {
  try {
    const toSave = {};
    Object.keys(PREMED_MASTER).forEach(sp => {
      if (PREMED_MASTER[sp]) toSave[sp] = PREMED_MASTER[sp];
    });
    localStorage.setItem('vetanes_drug_master_custom', JSON.stringify(toSave));
  } catch(e) { console.warn('Drug master save error:', e); }
}

function renderDrugMasterEditor() {
  const species = document.getElementById('dmSpeciesSelect').value;
  const area = document.getElementById('dmDrugListArea');
  if (!area) return;

  const drugs = PREMED_MASTER[species];
  if (!drugs) {
    area.innerHTML = '<div style="color:var(--text-muted);padding:20px;text-align:center;">„Åì„ÅÆÂãïÁâ©Á®Æ„ÅÆ„Éá„Éï„Ç©„É´„Éà„Éó„É≠„Éà„Ç≥„É´„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
    return;
  }

  let html = '';
  const cats = ['premed', 'induction', 'maintenance', 'analgesic', 'antibiotic', 'fluid'];
  cats.forEach(cat => {
    const info = PREMED_CATEGORY_LABELS[cat];
    const list = drugs[cat] || [];
    html += `<div class="dm-category">
      <div class="dm-category-title">${info.icon} ${info.label}</div>`;
    list.forEach((drug, idx) => {
      const isInhalant = drug.conc === null;
      html += `<div class="dm-drug-row" data-species="${species}" data-cat="${cat}" data-idx="${idx}">
        <input class="dm-drug-name" value="${drug.name}" data-field="name" placeholder="Ëñ¨Ââ§Âêç">
        ${isInhalant ? `<span class="dm-field-label" style="min-width:60px;text-align:center;">Âê∏ÂÖ•Ëñ¨</span>` :
        `<span class="dm-field-label">ÊøÉÂ∫¶</span>
        <input class="dm-drug-conc" type="number" step="any" value="${drug.conc||''}" data-field="conc" placeholder="ÊøÉÂ∫¶">
        <span class="dm-field-label">${drug.concUnit||'mg/mL'}</span>`}
        <span class="dm-field-label">Min</span>
        <input class="dm-drug-dose" type="number" step="any" value="${drug.doseMin}" data-field="doseMin">
        <span class="dm-field-label">Max</span>
        <input class="dm-drug-dose" type="number" step="any" value="${drug.doseMax}" data-field="doseMax">
        <span class="dm-field-label">${drug.doseUnit}</span>
        <input class="dm-drug-route" value="${drug.route}" data-field="route" placeholder="Êäï‰∏éÁµåË∑Ø">
        <div class="dm-drug-actions">
          <button class="dm-drug-move" onclick="moveDmDrug('${species}','${cat}',${idx},-1)" ${idx===0?'disabled':''}>‚ñ≤</button>
          <button class="dm-drug-move" onclick="moveDmDrug('${species}','${cat}',${idx},1)" ${idx===list.length-1?'disabled':''}>‚ñº</button>
        </div>
        <button class="dm-drug-delete" onclick="deleteDmDrug('${species}','${cat}',${idx})">‚úï</button>
      </div>`;
    });
    html += `<button class="btn-dm-add" onclick="addDmDrug('${species}','${cat}')">Ôºã ${info.label}„ÇíËøΩÂä†</button>
    </div>`;
  });
  area.innerHTML = html;
}

function collectDmEdits() {
  const rows = document.querySelectorAll('.dm-drug-row');
  rows.forEach(row => {
    const sp = row.dataset.species;
    const cat = row.dataset.cat;
    const idx = parseInt(row.dataset.idx);
    if (!PREMED_MASTER[sp] || !PREMED_MASTER[sp][cat] || !PREMED_MASTER[sp][cat][idx]) return;
    const drug = PREMED_MASTER[sp][cat][idx];
    row.querySelectorAll('input[data-field]').forEach(input => {
      const f = input.dataset.field;
      if (f === 'name' || f === 'route') {
        drug[f] = input.value;
      } else if (f === 'conc') {
        const v = parseFloat(input.value);
        drug.conc = isNaN(v) ? null : v;
      } else if (f === 'doseMin' || f === 'doseMax') {
        const v = parseFloat(input.value);
        if (!isNaN(v)) drug[f] = v;
      }
    });
  });
}

function addDmDrug(species, cat) {
  collectDmEdits();
  if (!PREMED_MASTER[species]) return;
  if (!PREMED_MASTER[species][cat]) PREMED_MASTER[species][cat] = [];
  const isMaintenanceCat = cat === 'maintenance';
  PREMED_MASTER[species][cat].push({
    name: 'Êñ∞Ë¶èËñ¨Ââ§',
    conc: isMaintenanceCat ? null : 1,
    concUnit: isMaintenanceCat ? null : 'mg/mL',
    doseMin: 0, doseMax: 0,
    doseUnit: isMaintenanceCat ? '%' : 'mg/kg',
    route: isMaintenanceCat ? 'Âê∏ÂÖ•' : 'iv'
  });
  renderDrugMasterEditor();
}

function deleteDmDrug(species, cat, idx) {
  collectDmEdits();
  if (PREMED_MASTER[species] && PREMED_MASTER[species][cat]) {
    PREMED_MASTER[species][cat].splice(idx, 1);
  }
  renderDrugMasterEditor();
}

function moveDmDrug(species, cat, idx, dir) {
  collectDmEdits();
  var arr = PREMED_MASTER[species] && PREMED_MASTER[species][cat];
  if (!arr) return;
  var newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= arr.length) return;
  var tmp = arr[idx];
  arr[idx] = arr[newIdx];
  arr[newIdx] = tmp;
  renderDrugMasterEditor();
}

function saveDrugMaster() {
  collectDmEdits();
  saveDrugMasterToStorage();
  alert('Ëñ¨Ââ§„Éû„Çπ„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü ‚úÖ');
}

function resetDrugMasterSpecies() {
  const species = document.getElementById('dmSpeciesSelect').value;
  if (!confirm(`${species} „ÅÆ„Éó„É≠„Éà„Ç≥„É´„Çí„Éá„Éï„Ç©„É´„Éà„Å´Êàª„Åó„Åæ„Åô„ÅãÔºü`)) return;
  if (PREMED_MASTER_DEFAULTS[species]) {
    PREMED_MASTER[species] = JSON.parse(JSON.stringify(PREMED_MASTER_DEFAULTS[species]));
  }
  saveDrugMasterToStorage();
  renderDrugMasterEditor();
}

// ===================================================================
//  POST-OP REPORT
// ===================================================================
function endAnesthesia() {
  if (!confirm('È∫ªÈÖî„ÇíÁµÇ‰∫Ü„Åó„Å¶„É¨„Éù„Éº„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü')) return;

  // Record end time
  var endTime = new Date();
  state.events.push({ name: 'È∫ªÈÖîÁµÇ‰∫Ü', time: endTime });
  addLog('üèÅ È∫ªÈÖîÁµÇ‰∫Ü');

  // Stop intervals
  if (state.elapsedInterval) { clearInterval(state.elapsedInterval); state.elapsedInterval = null; }
  if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; }
  if (state.announceInterval) { clearInterval(state.announceInterval); state.announceInterval = null; }
  if (state.voiceActive && state.recognition) { state.voiceActive = false; state.recognition.stop(); }

  generateReport();
}

function generateReport() {
  var content = document.getElementById('reportContent');
  if (!content) return;

  var p = state.patient;
  var sp = p.species;
  var spLabel = (SPECIES_LABELS[sp] || sp) + ' ' + (SPECIES_EMOJI[sp] || '');
  var wDisp = p.weight < 1 ? (p.weight * 1000).toFixed(0) + 'g' : p.weight.toFixed(1) + 'kg';
  var dateStr = p.date || new Date().toLocaleDateString('ja-JP');

  // Sex display
  var sexMap = { male: '‚ôÇ „Ç™„Çπ', castrated: '‚ôÇ ÂéªÂã¢„Ç™„Çπ', female: '‚ôÄ „É°„Çπ', spayed: '‚ôÄ ÈÅøÂ¶ä„É°„Çπ', unknown: '‰∏çÊòé' };
  var sexDisp = sexMap[p.sex] || p.sex || '-';

  // Duration
  var durationStr = '-';
  if (state.sessionStart) {
    var endEvt = null;
    for (var i = state.events.length - 1; i >= 0; i--) {
      if (state.events[i].name === 'È∫ªÈÖîÁµÇ‰∫Ü') { endEvt = state.events[i]; break; }
    }
    var endTime = endEvt ? endEvt.time : new Date();
    var durMs = endTime - state.sessionStart;
    var durH = Math.floor(durMs / 3600000);
    var durM = Math.floor((durMs % 3600000) / 60000);
    durationStr = (durH > 0 ? durH + 'ÊôÇÈñì' : '') + durM + 'ÂàÜ';
  }

  // --- Header ---
  var html = '';
  html += '<div class="report-header">';
  html += '<h1>È∫ªÈÖîË®òÈå≤</h1>';
  html += '<div class="report-subtitle">Anesthesia Record ‚Äî VetAnes</div>';
  html += '</div>';

  // --- Patient Info Table ---
  html += '<table class="report-patient-table">';
  html += '<tr><td class="label-cell">ÂÆüÊñΩÊó•</td><td>' + dateStr + '</td><td class="label-cell">ÊÇ£ËÄÖID</td><td>' + (p.id || '-') + '</td></tr>';
  html += '<tr><td class="label-cell">ÊÇ£ËÄÖÂêç</td><td>' + (p.name || '-') + '</td><td class="label-cell">ÂãïÁâ©Á®Æ</td><td>' + spLabel + '</td></tr>';
  html += '<tr><td class="label-cell">‰ΩìÈáç</td><td>' + wDisp + '</td><td class="label-cell">Âπ¥ÈΩ¢</td><td>' + (p.age || '-') + '</td></tr>';
  html += '<tr><td class="label-cell">ÊÄßÂà•</td><td>' + sexDisp + '</td><td class="label-cell">È∫ªÈÖîÊôÇÈñì</td><td>' + durationStr + '</td></tr>';
  html += '<tr><td class="label-cell">Âü∑ÂàÄÂåª</td><td>' + (p.surgeon || '-') + '</td><td class="label-cell">È∫ªÈÖîÊãÖÂΩì</td><td>' + (p.anesthetist || '-') + '</td></tr>';
  html += '<tr><td class="label-cell">Ë°ìÂºè</td><td colspan="3">' + (p.procedure || '-') + '</td></tr>';
  if (p.notes) {
    html += '<tr><td class="label-cell">ÂÇôËÄÉ</td><td colspan="3">' + p.notes + '</td></tr>';
  }
  html += '</table>';

  // --- Section A: Vital Graph ---
  html += '<div class="report-section-title">A. „Éê„Ç§„Çø„É´„Çµ„Ç§„É≥Êé®Áßª</div>';
  var chartCanvas = document.getElementById('vitalChart');
  if (chartCanvas) {
    try {
      var chartImg = chartCanvas.toDataURL('image/png');
      html += '<img class="report-chart-img" src="' + chartImg + '" alt="Vital Chart">';
    } catch(e) {
      html += '<p style="color:#999;">„ÉÅ„É£„Éº„ÉàÁîªÂÉè„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>';
    }
  }

  // --- Vital Data Table ---
  if (state.timeLabels.length > 0) {
    html += '<table class="report-vitals-table"><thead><tr><th>ÊôÇÂàª</th><th>HR</th><th>SpO2</th><th>RR</th><th>EtCO2</th><th>MAP</th></tr></thead><tbody>';
    for (var vi = 0; vi < state.timeLabels.length; vi++) {
      var tl = state.timeLabels[vi];
      if (tl === '+5min') continue;
      html += '<tr>';
      html += '<td>' + tl + '</td>';
      html += '<td>' + (state.vitals.hr[vi] !== undefined ? state.vitals.hr[vi] : '-') + '</td>';
      html += '<td>' + (state.vitals.spo2[vi] !== undefined ? state.vitals.spo2[vi] : '-') + '</td>';
      html += '<td>' + (state.vitals.rr[vi] !== undefined ? state.vitals.rr[vi] : '-') + '</td>';
      html += '<td>' + (state.vitals.etco2[vi] !== undefined ? state.vitals.etco2[vi] : '-') + '</td>';
      html += '<td>' + (state.vitals.mean[vi] !== undefined ? state.vitals.mean[vi] : '-') + '</td>';
      html += '</tr>';
    }
    html += '</tbody></table>';
  }

  // --- Section B: Anesthesia Timeline ---
  html += '<div class="report-section-title">B. È∫ªÈÖî„Çø„Ç§„É†„É©„Ç§„É≥</div>';
  if (state.events.length > 0) {
    html += '<table class="report-timeline"><thead><tr><th style="width:80px;">ÊôÇÂàª</th><th>„Ç§„Éô„É≥„Éà</th></tr></thead><tbody>';
    for (var ei = 0; ei < state.events.length; ei++) {
      var evt = state.events[ei];
      var evtTime = evt.time instanceof Date ? evt.time.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : '-';
      html += '<tr><td>' + evtTime + '</td><td>' + evt.name + '</td></tr>';
    }
    html += '</tbody></table>';
  } else {
    html += '<p style="color:#999; font-size:10px;">„Ç§„Éô„É≥„ÉàË®òÈå≤„Å™„Åó</p>';
  }

  // --- Section C: Drug Administration Summary ---
  html += '<div class="report-section-title">C. Ëñ¨Ââ§Êäï‰∏éË®òÈå≤</div>';
  // Collect drug entries from log
  var drugLogs = [];
  var logIds = Object.keys(state.logEntries);
  for (var li = 0; li < logIds.length; li++) {
    var le = state.logEntries[logIds[li]];
    if (le && le.text) {
      if (le.text.indexOf('üíä') === 0 || le.text.indexOf('üíâ') === 0) {
        drugLogs.push(le.text);
      }
    }
  }
  if (drugLogs.length > 0) {
    html += '<table class="report-drug-table"><thead><tr><th>Êäï‰∏éÂÜÖÂÆπ</th><th>ÂÇôËÄÉ</th></tr></thead><tbody>';
    for (var di = 0; di < drugLogs.length; di++) {
      var dText = drugLogs[di].replace(/^[üíäüíâ]\s*/, '');
      html += '<tr><td>' + dText + '</td><td></td></tr>';
    }
    html += '</tbody></table>';
  } else {
    html += '<p style="color:#999; font-size:10px;">Ëñ¨Ââ§Êäï‰∏éË®òÈå≤„Å™„Åó</p>';
  }

  // --- Section D: Full Log ---
  html += '<div class="report-section-title">D. ÂÖ®Ë®òÈå≤„É≠„Ç∞</div>';
  var allLogIds = Object.keys(state.logEntries);
  if (allLogIds.length > 0) {
    html += '<table class="report-timeline"><thead><tr><th style="width:80px;">No.</th><th>ÂÜÖÂÆπ</th></tr></thead><tbody>';
    // Reverse to chronological order (oldest first)
    for (var ai = allLogIds.length - 1; ai >= 0; ai--) {
      var aEntry = state.logEntries[allLogIds[ai]];
      var noteStr = aEntry.note ? ' <em style="color:#b45309;">[' + aEntry.note + ']</em>' : '';
      html += '<tr><td>' + (allLogIds.length - ai) + '</td><td>' + aEntry.text + noteStr + '</td></tr>';
    }
    html += '</tbody></table>';
  }

  // --- Section E: Notes ---
  html += '<div class="report-section-title">E. ÊâÄË¶ã„Éª„Ç≥„É°„É≥„Éà</div>';
  html += '<div class="report-notes-area" contenteditable="true" id="reportNotesArea">„Åì„Åì„Å´ÊâÄË¶ã„ÇíË®òÂÖ•...</div>';

  // --- Footer: Signatures ---
  html += '<div class="report-footer">';
  html += '<div class="report-sig-block"><div class="report-sig-line"></div><div class="report-sig-label">Âü∑ÂàÄÂåª: ' + (p.surgeon || '___________') + '</div></div>';
  html += '<div class="report-sig-block"><div class="report-sig-line"></div><div class="report-sig-label">È∫ªÈÖîÊãÖÂΩì: ' + (p.anesthetist || '___________') + '</div></div>';
  html += '</div>';

  content.innerHTML = html;
  document.getElementById('reportScreen').style.display = 'flex';
}

function printReport() {
  window.print();
}

function closeReport() {
  document.getElementById('reportScreen').style.display = 'none';
}

// ===================================================================
//  INIT: Event listeners (iPad-safe)
// ===================================================================
document.addEventListener('DOMContentLoaded', () => {
  try { loadCalibProfiles(); } catch(e) { console.warn('init calib error:', e); }
  try { loadDrugMasterFromStorage(); } catch(e) { console.warn('init drug master error:', e); }
  try { loadApiSettings(); } catch(e) { console.warn('init api settings error:', e); }

  // Close settings button
  const btnClose = document.getElementById('btnCloseSettings');
  if (btnClose) btnClose.addEventListener('click', () => closeSettings());

  // Tab buttons
  document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', function() { switchSettingsTab(this.dataset.tab); });
  });

  // Drug master species selector
  const dmSelect = document.getElementById('dmSpeciesSelect');
  if (dmSelect) dmSelect.addEventListener('change', () => { collectDmEdits(); renderDrugMasterEditor(); });

  // Drug master save
  const btnDmSave = document.getElementById('btnDmSave');
  if (btnDmSave) btnDmSave.addEventListener('click', () => saveDrugMaster());

  // Drug master reset
  const btnDmReset = document.getElementById('btnDmReset');
  if (btnDmReset) btnDmReset.addEventListener('click', () => resetDrugMasterSpecies());
});
</script>
</body>
</html>
